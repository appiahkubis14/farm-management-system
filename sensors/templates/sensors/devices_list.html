{% extends 'web_base.html' %}
{% load static %}

{% block content %}
<style>
:root {
    --primary: #3b82f6;
    --primary-light: #60a5fa;
    --primary-dark: #1d4ed8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #0ea5e9;
    --dark: #1f2937;
    --light: #ffffff;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
}

[data-theme="dark"] {
    --light: #111827;
    --gray-100: #1f2937;
    --gray-200: #374151;
    --gray-300: #4b5563;
    --gray-400: #6b7280;
    --gray-500: #9ca3af;
    --gray-600: #d1d5db;
    --gray-700: #e5e7eb;
    --gray-800: #f3f4f6;
    --gray-900: #f9fafb;
}

.devices-container {
    padding: 1.5rem;
    max-width: 100%;
    min-height: calc(100vh - 120px);
}

/* Header */
.devices-header {
    /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
    padding: 2rem;
    border-radius: 12px;
    /* color: white; */
    margin-bottom: 2rem;
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.header-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.header-subtitle {
    font-size: 1rem;
    opacity: 0.9;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.stat-card:nth-child(1)::before { background: linear-gradient(90deg, #3b82f6, #0ea5e9); }
.stat-card:nth-child(2)::before { background: linear-gradient(90deg, #10b981, #22c55e); }
.stat-card:nth-child(3)::before { background: linear-gradient(90deg, #f59e0b, #eab308); }
.stat-card:nth-child(4)::before { background: linear-gradient(90deg, #ef4444, #f87171); }

.stat-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.stat-card:nth-child(1) .stat-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
.stat-card:nth-child(2) .stat-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
.stat-card:nth-child(3) .stat-icon { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
.stat-card:nth-child(4) .stat-icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.25rem;
    font-variant-numeric: tabular-nums;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Devices Grid */
.devices-section {
    background: var(--light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dark);
}

.section-controls {
    display: flex;
    gap: 1rem;
}

.search-box {
    position: relative;
    min-width: 250px;
}

.search-input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    background: var(--light);
    color: var(--dark);
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    background: var(--light);
    color: var(--dark);
    font-size: 0.875rem;
    min-width: 150px;
    cursor: pointer;
}

.filter-select:focus {
    outline: none;
    border-color: var(--primary);
}

.devices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .devices-grid {
        grid-template-columns: 1fr;
    }
}

.device-card {
    background: var(--light);
    border-radius: 12px;
    border: 1px solid var(--gray-200);
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.device-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
}

.device-card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    background: var(--gray-100);
}

.device-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.device-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0;
    flex: 1;
}

.device-status {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-active {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-inactive {
    background: rgba(156, 163, 175, 0.1);
    color: #6b7280;
    border: 1px solid rgba(156, 163, 175, 0.2);
}

.status-maintenance {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.device-id {
    font-size: 0.875rem;
    color: var(--gray-500);
    background: var(--gray-200);
    padding: 0.25rem 0.75rem;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    display: inline-block;
    margin-bottom: 0.5rem;
}

.device-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 0.5rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.meta-icon {
    color: var(--gray-500);
}

.meta-value {
    color: var(--gray-700);
}

.device-card-body {
    padding: 1.5rem;
}

.device-type {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--gray-100);
    border-radius: 6px;
    font-size: 0.875rem;
    color: var(--gray-700);
    margin-bottom: 1rem;
}

.device-metrics {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.metric-item {
    text-align: center;
    padding: 1rem;
    background: var(--gray-100);
    border-radius: 8px;
    border: 1px solid var(--gray-200);
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    margin: 0.25rem 0;
    font-variant-numeric: tabular-nums;
}

.metric-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.temp-metric .metric-value { color: #ef4444; }
.humidity-metric .metric-value { color: #3b82f6; }
.soil-metric .metric-value { color: #10b981; }
.battery-metric .metric-value { color: #f59e0b; }

.device-card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--gray-200);
    background: var(--gray-100);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.device-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: var(--light);
    color: var(--gray-700);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: var(--gray-200);
    color: var(--primary);
}

.last-seen {
    font-size: 0.75rem;
    color: var(--gray-500);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--gray-500);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.5;
}

.empty-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--dark);
}

.empty-description {
    font-size: 1rem;
    margin-bottom: 2rem;
}

/* API Documentation */
.api-docs {
    background: var(--light);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
}

.docs-header {
    margin-bottom: 2rem;
}

.docs-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0 0 0.5rem 0;
}

.docs-subtitle {
    font-size: 1rem;
    color: var(--gray-500);
}

.code-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    padding-bottom: 0.5rem;
}

.code-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-500);
    cursor: pointer;
    position: relative;
    transition: all 0.2s ease;
}

.code-tab:hover {
    color: var(--primary);
}

.code-tab.active {
    color: var(--primary);
}

.code-tab.active::after {
    content: '';
    position: absolute;
    bottom: -0.5rem;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary);
}

.code-block {
    background: var(--gray-100);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.code-header {
    padding: 1rem 1.5rem;
    background: var(--gray-200);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.code-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0;
}

.copy-btn {
    padding: 0.5rem 1rem;
    background: var(--light);
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    font-size: 0.75rem;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-btn:hover {
    background: var(--gray-200);
}

.code-content {
    padding: 1.5rem;
    overflow-x: auto;
}

.code-content pre {
    margin: 0;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--dark);
}

/* Response Example */
.response-example {
    background: var(--gray-100);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.response-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 1rem;
}

/* Buttons */
.btn {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-secondary {
    background: var(--gray-200);
    color: var(--gray-800);
}

.btn-secondary:hover {
    background: var(--gray-300);
    transform: translateY(-2px);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: #0da271;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

@media (max-width: 768px) {
    .devices-container {
        padding: 1rem;
    }
    
    .devices-header {
        padding: 1.5rem;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .header-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .section-controls {
        flex-direction: column;
        width: 100%;
    }
    
    .search-box {
        width: 100%;
    }
    
    .devices-grid {
        grid-template-columns: 1fr;
    }
    
    .device-metrics {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<div class="devices-container">
    <!-- Header -->
    <div class="devices-header">
        <div class="header-content">
            <div>
                <h1 class="header-title">üì± IoT Devices Management</h1>
                <p class="header-subtitle">Monitor and manage all your connected sensor devices</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'sensors:devices_management' %}" class="btn btn-success">
                    <span>‚öôÔ∏è</span>
                    <span>Manage Devices</span>
                </a>
                <a href="{% url 'sensors:websocket_test' %}" class="btn btn-secondary">
                    <span>üîå</span>
                    <span>Test WebSocket</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üì±</div>
            <div class="stat-value">{{ devices|length }}</div>
            <div class="stat-label">Total Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value">{{ active_devices|default:"0" }}</div>
            <div class="stat-label">Active Devices</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üîÑ</div>
            <div class="stat-value">{{ maintenance_devices|default:"0" }}</div>
            <div class="stat-label">In Maintenance</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-value">{{ total_readings|default:"0" }}</div>
            <div class="stat-label">Total Readings</div>
        </div>
    </div>

    <!-- Devices Section -->
    <div class="devices-section">
        <div class="section-header">
            <h2 class="section-title">Connected Devices</h2>
            <div class="section-controls">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchDevices" placeholder="Search devices...">
                </div>
                <select class="filter-select" id="filterStatus">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="maintenance">Maintenance</option>
                </select>
                <select class="filter-select" id="filterType">
                    <option value="all">All Types</option>
                    <option value="soil">Soil Sensors</option>
                    <option value="temperature">Temperature</option>
                    <option value="humidity">Humidity</option>
                    <option value="multi">Multi-Sensors</option>
                </select>
            </div>
        </div>

        <div class="devices-grid" id="devicesGrid">
            {% for device in devices %}
            {% with latest_reading=device.readings.first %}
            <div class="device-card" onclick="window.location.href='{% url 'sensors:device_detail' device.device_id %}'">
                <div class="device-card-header">
                    <div class="device-header-top">
                        <h3 class="device-name">{{ device.device_name }}</h3>
                        <span class="device-status status-{{ device.status }}">
                            {{ device.get_status_display }}
                        </span>
                    </div>
                    <div class="device-id">{{ device.device_id }}</div>
                    <div class="device-meta">
                        <div class="meta-item">
                            <span class="meta-icon">üìç</span>
                            <span class="meta-value">{{ device.location|default:"Location not set" }}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üìÖ</span>
                            <span class="meta-value">{{ device.registered_at|date:"M d, Y" }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="device-card-body">
                    <div class="device-type">
                        <span>
                            {% if device.device_type == 'soil' %}üå± Soil Moisture Sensor{% endif %}
                            {% if device.device_type == 'temperature' %}üå°Ô∏è Temperature Sensor{% endif %}
                            {% if device.device_type == 'humidity' %}üíß Humidity Sensor{% endif %}
                            {% if device.device_type == 'multi' %}üì° Multi-Sensor Device{% endif %}
                        </span>
                    </div>
                    
                    <div class="device-metrics">
                        <div class="metric-item temp-metric">
                            <div class="metric-label">Temperature</div>
                            <div class="metric-value">
                                {% if latest_reading and latest_reading.temperature %}
                                {{ latest_reading.temperature|floatformat:1 }}
                                {% else %}
                                --
                                {% endif %}
                            </div>
                            <div class="metric-label">¬∞C</div>
                        </div>
                        
                        <div class="metric-item humidity-metric">
                            <div class="metric-label">Humidity</div>
                            <div class="metric-value">
                                {% if latest_reading and latest_reading.humidity %}
                                {{ latest_reading.humidity|floatformat:0 }}
                                {% else %}
                                --
                                {% endif %}
                            </div>
                            <div class="metric-label">%</div>
                        </div>
                        
                        <div class="metric-item soil-metric">
                            <div class="metric-label">Soil Moisture</div>
                            <div class="metric-value">
                                {% if latest_reading and latest_reading.soil_moisture %}
                                {{ latest_reading.soil_moisture|floatformat:0 }}
                                {% else %}
                                --
                                {% endif %}
                            </div>
                            <div class="metric-label">%</div>
                        </div>
                        
                        <div class="metric-item battery-metric">
                            <div class="metric-label">Battery</div>
                            <div class="metric-value">
                                {% if latest_reading and latest_reading.battery_level %}
                                {{ latest_reading.battery_level|floatformat:0 }}
                                {% else %}
                                --
                                {% endif %}
                            </div>
                            <div class="metric-label">%</div>
                        </div>
                    </div>
                </div>
                
                <div class="device-card-footer">
                    <div class="device-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); window.location.href='{% url 'sensors:device_detail' device.device_id %}'" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); copyDeviceId('{{ device.device_id }}')" title="Copy Device ID">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="last-seen">
                        Last seen {{ device.last_seen|timesince }} ago
                    </div>
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-icon">üì°</div>
                <h3 class="empty-title">No Devices Found</h3>
                <p class="empty-description">No devices have been registered yet. Register your first device through the API.</p>
                <a href="#api-docs" class="btn btn-primary">
                    <span>üìö</span>
                    <span>View API Documentation</span>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- API Documentation -->
    <div class="api-docs" id="api-docs">
        <div class="docs-header">
            <h2 class="docs-title">üìñ API Documentation</h2>
            <p class="docs-subtitle">Learn how to register devices and send sensor data</p>
        </div>
        
        <div class="code-tabs">
            <button class="code-tab active" data-tab="register">Register Device</button>
            <button class="code-tab" data-tab="submit">Submit Data</button>
            <button class="code-tab" data-tab="get">Get Data</button>
        </div>
        
        <!-- Register Device Tab -->
        <div class="code-block" id="register-tab">
            <div class="code-header">
                <h4 class="code-title">Register a New Device</h4>
                <button class="copy-btn" onclick="copyCode('register-code')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="code-content">
                <pre id="register-code"><code>POST /api/register/
Content-Type: application/json

{
    "device_id": "ESP32-001",
    "device_name": "Garden Sensor 1",
    "device_type": "multi",
    "location": "Garden A, Backyard"
}</code></pre>
            </div>
            
            <div class="response-example">
                <div class="response-title">Response Example:</div>
                <pre><code>{
    "success": true,
    "device_id": "ESP32-001",
    "api_key": "550e8400-e29b-41d4-a716-446655440000",
    "created": true
}</code></pre>
            </div>
        </div>
        
        <!-- Submit Data Tab -->
        <div class="code-block" id="submit-tab" style="display: none;">
            <div class="code-header">
                <h4 class="code-title">Submit Sensor Readings</h4>
                <button class="copy-btn" onclick="copyCode('submit-code')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="code-content">
                <pre id="submit-code"><code>POST /api/submit/
Content-Type: application/json

{
    "device_id": "ESP32-001",
    "api_key": "your-device-api-key",
    "temperature": 25.5,
    "humidity": 65.0,
    "soil_moisture": 45.0,
    "soil_raw": 2048,
    "battery_level": 85.0,
    "signal_strength": -65,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
            </div>
            
            <div class="response-example">
                <div class="response-title">Response Example:</div>
                <pre><code>{
    "success": true,
    "reading_id": 123,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
            </div>
        </div>
        
        <!-- Get Data Tab -->
        <div class="code-block" id="get-tab" style="display: none;">
            <div class="code-header">
                <h4 class="code-title">Retrieve Device Data</h4>
                <button class="copy-btn" onclick="copyCode('get-code')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="code-content">
                <pre id="get-code"><code># Get recent readings for a device
GET /api/device/ESP32-001/readings/?limit=100

# Get device statistics
GET /api/device/ESP32-001/stats/?hours=24

# Get all devices with latest readings
GET /api/devices/</code></pre>
            </div>
            
            <div class="response-example">
                <div class="response-title">Response Example:</div>
                <pre><code>{
    "device_id": "ESP32-001",
    "device_name": "Garden Sensor 1",
    "readings": [
        {
            "id": 123,
            "device_id": "ESP32-001",
            "timestamp": "2024-01-15T14:30:00Z",
            "temperature": 25.5,
            "humidity": 65.0,
            "soil_moisture": 45.0,
            "soil_raw": 2048,
            "battery_level": 85.0,
            "signal_strength": -65
        }
    ]
}</code></pre>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search and filter
    setupSearchFilter();
    setupCodeTabs();
    
    // Load device stats
    loadDeviceStats();
});

// Setup search and filter functionality
function setupSearchFilter() {
    const searchInput = document.getElementById('searchDevices');
    const statusFilter = document.getElementById('filterStatus');
    const typeFilter = document.getElementById('filterType');
    const devicesGrid = document.getElementById('devicesGrid');
    
    function filterDevices() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const typeValue = typeFilter.value;
        
        const deviceCards = devicesGrid.querySelectorAll('.device-card');
        let visibleCount = 0;
        
        deviceCards.forEach(card => {
            const deviceName = card.querySelector('.device-name').textContent.toLowerCase();
            const deviceId = card.querySelector('.device-id').textContent.toLowerCase();
            const deviceStatus = card.querySelector('.device-status').textContent.toLowerCase();
            const deviceType = card.querySelector('.device-type span').textContent.toLowerCase();
            
            // Apply filters
            const matchesSearch = searchTerm === '' || 
                deviceName.includes(searchTerm) || 
                deviceId.includes(searchTerm);
                
            const matchesStatus = statusValue === 'all' || 
                (statusValue === 'active' && deviceStatus === 'active') ||
                (statusValue === 'inactive' && deviceStatus === 'inactive') ||
                (statusValue === 'maintenance' && deviceStatus === 'maintenance');
                
            const matchesType = typeValue === 'all' ||
                (typeValue === 'soil' && deviceType.includes('soil')) ||
                (typeValue === 'temperature' && deviceType.includes('temperature')) ||
                (typeValue === 'humidity' && deviceType.includes('humidity')) ||
                (typeValue === 'multi' && deviceType.includes('multi'));
            
            if (matchesSearch && matchesStatus && matchesType) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        // Show empty state if no devices visible
        const emptyState = devicesGrid.querySelector('.empty-state');
        if (visibleCount === 0 && !emptyState) {
            devicesGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-icon">üîç</div>
                    <h3 class="empty-title">No Matching Devices</h3>
                    <p class="empty-description">No devices match your search criteria. Try adjusting your filters.</p>
                    <button class="btn btn-secondary" onclick="clearFilters()">
                        <span>üîÑ</span>
                        <span>Clear Filters</span>
                    </button>
                </div>
            `;
        }
    }
    
    // Add event listeners
    searchInput.addEventListener('input', filterDevices);
    statusFilter.addEventListener('change', filterDevices);
    typeFilter.addEventListener('change', filterDevices);
}

// Setup code tabs
function setupCodeTabs() {
    const tabs = document.querySelectorAll('.code-tab');
    const tabContents = {
        'register': document.getElementById('register-tab'),
        'submit': document.getElementById('submit-tab'),
        'get': document.getElementById('get-tab')
    };
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Hide all tab contents
            Object.values(tabContents).forEach(content => {
                if (content) content.style.display = 'none';
            });
            
            // Show selected tab content
            const tabName = this.dataset.tab;
            if (tabContents[tabName]) {
                tabContents[tabName].style.display = 'block';
            }
        });
    });
}

// Load device statistics
function loadDeviceStats() {
    // You could fetch real-time stats here
    // Example: fetch('/api/dashboard-stats/').then(...)
}

// Copy device ID
function copyDeviceId(deviceId) {
    navigator.clipboard.writeText(deviceId).then(() => {
        showToast('Device ID copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Copy code to clipboard
function copyCode(codeId) {
    const codeElement = document.getElementById(codeId);
    const codeText = codeElement.textContent;
    
    navigator.clipboard.writeText(codeText).then(() => {
        showToast('Code copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Clear filters
function clearFilters() {
    document.getElementById('searchDevices').value = '';
    document.getElementById('filterStatus').value = 'all';
    document.getElementById('filterType').value = 'all';
    
    // Trigger filter
    document.getElementById('searchDevices').dispatchEvent(new Event('input'));
    
    // Scroll to devices grid
    document.querySelector('.devices-section').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

// Show toast notification
function showToast(message) {
    // Remove existing toast
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
        <div style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        ">
            <span>‚úÖ</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 300);
    }, 3000);
}

// Add toast animations
const toastStyle = document.createElement('style');
toastStyle.textContent = `
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
`;
document.head.appendChild(toastStyle);
</script>
{% endblock %}