{% extends 'web_base.html' %}
{% load static %}

{% block content %}
<style>
:root {
    --primary: #3b82f6;
    --primary-light: #60a5fa;
    --primary-dark: #1d4ed8;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1f2937;
    --light: #ffffff;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
}

[data-theme="dark"] {
    --light: #111827;
    --gray-100: #1f2937;
    --gray-200: #374151;
    --gray-300: #4b5563;
    --gray-400: #6b7280;
    --gray-500: #9ca3af;
    --gray-600: #d1d5db;
    --gray-700: #e5e7eb;
    --gray-800: #f3f4f6;
    --gray-900: #f9fafb;
}

.device-detail-container {
    padding: 1.5rem;
    max-width: 100%;
    height: calc(100vh - 120px);
    overflow-y: auto;
}

/* Header Section */
.device-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--light);
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
}

.device-info {
    flex: 1;
}

.device-title {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.device-name {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--dark);
    margin: 0;
}

.device-id {
    font-size: 0.875rem;
    color: var(--gray-500);
    background: var(--gray-100);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-family: 'Courier New', monospace;
}

.device-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-top: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.meta-label {
    font-size: 0.875rem;
    color: var(--gray-500);
}

.meta-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--dark);
}

.device-actions {
    display: flex;
    gap: 0.75rem;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn-secondary {
    background: var(--gray-200);
    color: var(--gray-800);
}

.btn-secondary:hover {
    background: var(--gray-300);
    transform: translateY(-1px);
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-active {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.status-inactive {
    background: rgba(156, 163, 175, 0.1);
    color: var(--gray-500);
    border: 1px solid rgba(156, 163, 175, 0.2);
}

.status-maintenance {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

/* Real-time Stats Grid */
.realtime-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--light);
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.stat-card:nth-child(1)::before { background: linear-gradient(90deg, #ef4444, #f97316); }
.stat-card:nth-child(2)::before { background: linear-gradient(90deg, #3b82f6, #0ea5e9); }
.stat-card:nth-child(3)::before { background: linear-gradient(90deg, #10b981, #22c55e); }
.stat-card:nth-child(4)::before { background: linear-gradient(90deg, #8b5cf6, #a855f7); }

.stat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.stat-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
}

.stat-card:nth-child(1) .stat-icon { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.stat-card:nth-child(2) .stat-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
.stat-card:nth-child(3) .stat-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
.stat-card:nth-child(4) .stat-icon { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }

.stat-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.25rem;
    font-variant-numeric: tabular-nums;
}

.stat-unit {
    font-size: 0.875rem;
    color: var(--gray-500);
    margin-left: 0.25rem;
}

.stat-timestamp {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Charts Section */
.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 1200px) {
    .charts-section {
        grid-template-columns: 1fr;
    }
}

.chart-container {
    background: var(--light);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.chart-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0;
}

.chart-controls {
    display: flex;
    gap: 0.5rem;
}

.time-range-btn {
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--gray-300);
    background: var(--gray-100);
    color: var(--gray-700);
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-range-btn:hover {
    background: var(--gray-200);
}

.time-range-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.chart-wrapper {
    position: relative;
    height: 300px;
    width: 100%;
}

/* Readings Table */
.readings-section {
    background: var(--light);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
}

.table-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--gray-200);
}

.table-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0;
}

.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
}

.table-search {
    position: relative;
    flex: 1;
    max-width: 300px;
}

.table-search input {
    width: 100%;
    padding: 0.5rem 2.5rem 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    background: var(--light);
    color: var(--dark);
    font-size: 0.875rem;
}

.table-search i {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.table-wrapper {
    overflow-x: auto;
}

.readings-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.readings-table th {
    padding: 1rem 1.5rem;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    background: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.readings-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
    color: var(--dark);
    font-size: 0.875rem;
}

.readings-table tbody tr:hover {
    background: var(--gray-100);
}

.readings-table tbody tr:last-child td {
    border-bottom: none;
}

.value-cell {
    font-variant-numeric: tabular-nums;
    font-weight: 500;
}

.temp-cell { color: #ef4444; }
.humidity-cell { color: #3b82f6; }
.soil-cell { color: #10b981; }
.battery-cell { color: #f59e0b; }

.battery-low { color: #ef4444; font-weight: 600; }
.battery-medium { color: #f59e0b; }
.battery-high { color: #10b981; }

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.pulse {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success);
    margin-right: 0.5rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@media (max-width: 768px) {
    .device-detail-container {
        padding: 1rem;
        height: calc(100vh - 100px);
    }
    
    .device-header {
        flex-direction: column;
        gap: 1rem;
    }
    
    .device-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .chart-container {
        padding: 1rem;
    }
    
    .chart-wrapper {
        height: 250px;
    }
    
    .realtime-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .stat-card {
        padding: 1rem;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }
}
</style>

<div class="device-detail-container">
    <!-- Device Header -->
    <div class="device-header">
        <div class="device-info">
            <div class="device-title">
                <h1 class="device-name">{{ device.device_name }}</h1>
                <span class="device-id">{{ device.device_id }}</span>
                <span class="status-badge status-{{ device.status }}">
                    {{ device.get_status_display }}
                </span>
            </div>
            
            <div class="device-meta">
                <div class="meta-item">
                    <span class="meta-label">üìç</span>
                    <span class="meta-value">{{ device.location|default:"Location not set" }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">üì°</span>
                    <span class="meta-value">{{ device.get_device_type_display }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">üìÖ</span>
                    <span class="meta-value">Registered {{ device.registered_at|date:"M d, Y" }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">üïí</span>
                    <span class="meta-value" id="lastSeen">{{ device.last_seen|timesince }} ago</span>
                </div>
            </div>
        </div>
        
        <div class="device-actions">
            <a href="/sensors/dashboard/" class="btn btn-secondary">
                <span>‚Üê</span>
                <span>Back to Dashboard</span>
            </a>
            <button class="btn btn-primary" onclick="refreshData()">
                <span>üîÑ</span>
                <span>Refresh</span>
            </button>
        </div>
    </div>

    <!-- Real-time Stats -->
    <div class="realtime-stats">
        <div class="stat-card" id="tempStat">
            <div class="stat-header">
                <div class="stat-icon">üå°Ô∏è</div>
                <div>
                    <div class="stat-title">Temperature</div>
                    <div class="stat-value">--</div>
                </div>
            </div>
            <div class="stat-timestamp">
                <span class="pulse"></span>
                <span>Waiting for data...</span>
            </div>
        </div>
        
        <div class="stat-card" id="humidityStat">
            <div class="stat-header">
                <div class="stat-icon">üíß</div>
                <div>
                    <div class="stat-title">Humidity</div>
                    <div class="stat-value">--</div>
                </div>
            </div>
            <div class="stat-timestamp">
                <span class="pulse"></span>
                <span>Waiting for data...</span>
            </div>
        </div>
        
        <div class="stat-card" id="soilStat">
            <div class="stat-header">
                <div class="stat-icon">üå±</div>
                <div>
                    <div class="stat-title">Soil Moisture</div>
                    <div class="stat-value">--</div>
                </div>
            </div>
            <div class="stat-timestamp">
                <span class="pulse"></span>
                <span>Waiting for data...</span>
            </div>
        </div>
        
        <div class="stat-card" id="soilRawStat">
            <div class="stat-header">
                <div class="stat-icon">üìä</div>
                <div>
                    <div class="stat-title">Raw Value</div>
                    <div class="stat-value">--</div>
                </div>
            </div>
            <div class="stat-timestamp">
                <span class="pulse"></span>
                <span>Waiting for data...</span>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Temperature Trends</h3>
                <div class="chart-controls">
                    <button class="time-range-btn active" data-range="1h">1H</button>
                    <button class="time-range-btn" data-range="6h">6H</button>
                    <button class="time-range-btn" data-range="24h">24H</button>
                    <button class="time-range-btn" data-range="7d">7D</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Humidity Trends</h3>
                <div class="chart-controls">
                    <button class="time-range-btn active" data-range="1h">1H</button>
                    <button class="time-range-btn" data-range="6h">6H</button>
                    <button class="time-range-btn" data-range="24h">24H</button>
                    <button class="time-range-btn" data-range="7d">7D</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="humidityChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Soil Moisture Trends</h3>
                <div class="chart-controls">
                    <button class="time-range-btn active" data-range="1h">1H</button>
                    <button class="time-range-btn" data-range="6h">6H</button>
                    <button class="time-range-btn" data-range="24h">24H</button>
                    <button class="time-range-btn" data-range="7d">7D</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="soilChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Raw Sensor Values</h3>
                <div class="chart-controls">
                    <button class="time-range-btn active" data-range="1h">1H</button>
                    <button class="time-range-btn" data-range="6h">6H</button>
                    <button class="time-range-btn" data-range="24h">24H</button>
                    <button class="time-range-btn" data-range="7d">7D</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="soilRawChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Readings Table -->
    <div class="readings-section">
        <div class="table-header">
            <h3 class="table-title">Recent Readings</h3>
            <div class="table-controls">
                <div class="table-search">
                    <input type="text" id="searchReadings" placeholder="Search readings...">
                    <i class="fas fa-search"></i>
                </div>
                <div>
                    <select id="timeFilter" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--light); color: var(--dark);">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="table-wrapper">
            <table class="readings-table">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Temperature</th>
                        <th>Humidity</th>
                        <th>Soil Moisture</th>
                        <th>Raw Value</th>
                        <th>Battery</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody id="readingsTableBody">
                    {% for reading in recent_readings %}
                    <tr>
                        <td>{{ reading.timestamp|date:"M d, H:i:s" }}</td>
                        <td class="value-cell temp-cell">
                            {{ reading.temperature|floatformat:1|default:"-" }}<span class="stat-unit">¬∞C</span>
                        </td>
                        <td class="value-cell humidity-cell">
                            {{ reading.humidity|floatformat:0|default:"-" }}<span class="stat-unit">%</span>
                        </td>
                        <td class="value-cell soil-cell">
                            {{ reading.soil_moisture|floatformat:0|default:"-" }}<span class="stat-unit">%</span>
                        </td>
                        <td class="value-cell">
                            {{ reading.soil_raw|default:"-" }}
                        </td>
                        <td class="value-cell {% if reading.battery_level < 20 %}battery-low{% elif reading.battery_level < 50 %}battery-medium{% else %}battery-high{% endif %}">
                            {{ reading.battery_level|floatformat:0|default:"-" }}<span class="stat-unit">%</span>
                        </td>
                        <td class="value-cell">
                            {{ reading.signal_strength|default:"-" }}<span class="stat-unit">dB</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const deviceId = '{{ device.device_id }}';
let charts = {};
let currentTimeRange = '1h';
let lastUpdateTime = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadInitialData();
    setupEventListeners();
    updateLastSeen();
    
    // Update last seen every minute
    setInterval(updateLastSeen, 60000);
});

// Initialize all charts
function initializeCharts() {
    const chartConfigs = {
        temperatureChart: {
            color: '#ef4444',
            label: 'Temperature',
            unit: '¬∞C'
        },
        humidityChart: {
            color: '#3b82f6',
            label: 'Humidity',
            unit: '%'
        },
        soilChart: {
            color: '#10b981',
            label: 'Soil Moisture',
            unit: '%'
        },
        soilRawChart: {
            color: '#8b5cf6',
            label: 'Raw Value',
            unit: ''
        }
    };
    
    Object.keys(chartConfigs).forEach(chartId => {
        const config = chartConfigs[chartId];
        const ctx = document.getElementById(chartId).getContext('2d');
        const isDark = document.documentElement.hasAttribute('data-theme');
        
        charts[chartId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: config.label,
                    data: [],
                    borderColor: config.color,
                    backgroundColor: `${config.color}20`,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: config.color,
                    pointBorderColor: isDark ? '#111827' : '#ffffff',
                    pointRadius: 3,
                    pointHoverRadius: 6,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${config.label}: ${context.parsed.y}${config.unit}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: isDark ? '#d1d5db' : '#6b7280',
                            maxRotation: 0
                        }
                    },
                    y: {
                        grid: {
                            color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                        },
                        ticks: {
                            color: isDark ? '#d1d5db' : '#6b7280'
                        },
                        title: {
                            display: true,
                            text: config.unit,
                            color: isDark ? '#d1d5db' : '#6b7280'
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            }
        });
    });
}

// Load initial data
async function loadInitialData() {
    try {
        const response = await fetch(`/sensors/api/device/${deviceId}/readings/?limit=100`);
        const data = await response.json();
        
        if (data.readings) {
            // Process and display data
            data.readings.forEach(reading => {
                updateCharts(reading);
            });
            
            // Update stats with latest reading
            if (data.readings.length > 0) {
                updateStats(data.readings[0]);
            }
            
            // Initialize table with data
            populateTable(data.readings);
        }
    } catch (error) {
        console.error('Error loading initial data:', error);
    }
}

// Update stats cards
function updateStats(reading) {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Temperature
    if (reading.temperature !== null) {
        const tempEl = document.querySelector('#tempStat .stat-value');
        tempEl.innerHTML = `${reading.temperature.toFixed(1)}<span class="stat-unit">¬∞C</span>`;
        document.querySelector('#tempStat .stat-timestamp').innerHTML = 
            `<span class="pulse"></span><span>Updated ${timeString}</span>`;
    }
    
    // Humidity
    if (reading.humidity !== null) {
        const humEl = document.querySelector('#humidityStat .stat-value');
        humEl.innerHTML = `${reading.humidity.toFixed(0)}<span class="stat-unit">%</span>`;
        document.querySelector('#humidityStat .stat-timestamp').innerHTML = 
            `<span class="pulse"></span><span>Updated ${timeString}</span>`;
    }
    
    // Soil Moisture
    if (reading.soil_moisture !== null) {
        const soilEl = document.querySelector('#soilStat .stat-value');
        soilEl.innerHTML = `${reading.soil_moisture.toFixed(0)}<span class="stat-unit">%</span>`;
        document.querySelector('#soilStat .stat-timestamp').innerHTML = 
            `<span class="pulse"></span><span>Updated ${timeString}</span>`;
    }
    
    // Soil Raw
    if (reading.soil_raw !== null) {
        const rawEl = document.querySelector('#soilRawStat .stat-value');
        rawEl.innerHTML = `${reading.soil_raw}<span class="stat-unit"></span>`;
        document.querySelector('#soilRawStat .stat-timestamp').innerHTML = 
            `<span class="pulse"></span><span>Updated ${timeString}</span>`;
    }
}

// Update charts with new data
function updateCharts(reading) {
    const time = new Date(reading.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // Temperature
    if (reading.temperature !== null) {
        addChartData('temperatureChart', time, reading.temperature);
    }
    
    // Humidity
    if (reading.humidity !== null) {
        addChartData('humidityChart', time, reading.humidity);
    }
    
    // Soil Moisture
    if (reading.soil_moisture !== null) {
        addChartData('soilChart', time, reading.soil_moisture);
    }
    
    // Soil Raw
    if (reading.soil_raw !== null) {
        addChartData('soilRawChart', time, reading.soil_raw);
    }
}

// Add data point to chart
function addChartData(chartId, label, value) {
    const chart = charts[chartId];
    
    if (!chart) return;
    
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);
    
    // Keep only last 20 data points
    if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    
    chart.update('none');
}

// Populate table with data
function populateTable(readings) {
    const tbody = document.getElementById('readingsTableBody');
    tbody.innerHTML = '';
    
    readings.forEach(reading => {
        const row = createTableRow(reading);
        tbody.appendChild(row);
    });
}

// Create table row from reading data
function createTableRow(reading) {
    const row = document.createElement('tr');
    const time = new Date(reading.timestamp).toLocaleString([], {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    const batteryClass = reading.battery_level < 20 ? 'battery-low' : 
                        reading.battery_level < 50 ? 'battery-medium' : 'battery-high';
    
    row.innerHTML = `
        <td>${time}</td>
        <td class="value-cell temp-cell">
            ${reading.temperature ? reading.temperature.toFixed(1) + '<span class="stat-unit">¬∞C</span>' : '-'}
        </td>
        <td class="value-cell humidity-cell">
            ${reading.humidity ? reading.humidity.toFixed(0) + '<span class="stat-unit">%</span>' : '-'}
        </td>
        <td class="value-cell soil-cell">
            ${reading.soil_moisture ? reading.soil_moisture.toFixed(0) + '<span class="stat-unit">%</span>' : '-'}
        </td>
        <td class="value-cell">
            ${reading.soil_raw !== null && reading.soil_raw !== undefined ? reading.soil_raw : '-'}
        </td>
        <td class="value-cell ${batteryClass}">
            ${reading.battery_level ? reading.battery_level.toFixed(0) + '<span class="stat-unit">%</span>' : '-'}
        </td>
        <td class="value-cell">
            ${reading.signal_strength ? reading.signal_strength + '<span class="stat-unit">dB</span>' : '-'}
        </td>
    `;
    
    return row;
}

// Setup event listeners
function setupEventListeners() {
    // Time range buttons
    document.querySelectorAll('.time-range-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTimeRange = this.dataset.range;
            loadTimeRangeData(currentTimeRange);
        });
    });
    
    // Search input
    document.getElementById('searchReadings').addEventListener('input', function(e) {
        filterTable(e.target.value);
    });
    
    // Time filter
    document.getElementById('timeFilter').addEventListener('change', function(e) {
        loadFilteredData(e.target.value);
    });
}

// Load data for selected time range
async function loadTimeRangeData(range) {
    let hours = 1;
    switch(range) {
        case '6h': hours = 6; break;
        case '24h': hours = 24; break;
        case '7d': hours = 168; break;
    }
    
    try {
        const response = await fetch(`/sensors/api/device/${deviceId}/stats/?hours=${hours}`);
        const data = await response.json();
        
        // Clear existing chart data
        Object.values(charts).forEach(chart => {
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
        });
        
        // Process and add new data
        if (data.readings) {
            data.readings.forEach(reading => {
                updateCharts(reading);
            });
        }
    } catch (error) {
        console.error('Error loading time range data:', error);
    }
}

// Filter table rows
function filterTable(searchTerm) {
    const rows = document.querySelectorAll('#readingsTableBody tr');
    const term = searchTerm.toLowerCase();
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}

// Load filtered data
async function loadFilteredData(filter) {
    let url = `/sensors/api/device/${deviceId}/readings/?limit=50`;
    
    switch(filter) {
        case 'today':
            url += '&today=true';
            break;
        case 'week':
            url += '&week=true';
            break;
        case 'month':
            url += '&month=true';
            break;
    }
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.readings) {
            populateTable(data.readings);
        }
    } catch (error) {
        console.error('Error loading filtered data:', error);
    }
}

// Update last seen time
function updateLastSeen() {
    const lastSeenEl = document.getElementById('lastSeen');
    if (lastUpdateTime) {
        const diff = Math.floor((Date.now() - lastUpdateTime) / 1000);
        lastSeenEl.textContent = diff < 60 ? 'just now' : 
                                diff < 3600 ? `${Math.floor(diff/60)}m ago` : 
                                `${Math.floor(diff/3600)}h ago`;
    }
}

// Handle sensor updates from WebSocket
function handleSensorUpdate(data) {
    if (data.device_id === deviceId) {
        lastUpdateTime = Date.now();
        
        // Update stats
        updateStats(data);
        
        // Update charts
        updateCharts(data);
        
        // Add to table
        const tbody = document.getElementById('readingsTableBody');
        const row = createTableRow(data);
        tbody.insertBefore(row, tbody.firstChild);
        
        // Keep only 100 rows
        while (tbody.children.length > 100) {
            tbody.removeChild(tbody.lastChild);
        }
        
        // Update last seen
        updateLastSeen();
    }
}

// Refresh data manually
async function refreshData() {
    const btn = event?.target || document.querySelector('.btn-primary');
    const originalHTML = btn.innerHTML;
    
    btn.innerHTML = '<span class="loading" style="display: inline-block; width: 16px; height: 16px; margin-right: 8px;"></span><span>Refreshing...</span>';
    btn.disabled = true;
    
    try {
        await loadTimeRangeData(currentTimeRange);
        
        // Flash stats cards to indicate update
        document.querySelectorAll('.stat-card').forEach(card => {
            card.style.animation = 'none';
            setTimeout(() => {
                card.style.animation = 'flash 0.5s';
            }, 10);
        });
        
    } catch (error) {
        console.error('Error refreshing data:', error);
    } finally {
        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }, 1000);
    }
}

// Add flash animation
const style = document.createElement('style');
style.textContent = `
@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
}
`;
document.head.appendChild(style);

// Initialize WebSocket connection for real-time updates
function initWebSocket() {
    const wsScheme = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const wsUrl = wsScheme + window.location.host + '/ws/device/' + deviceId + '/';
    
    const ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
        console.log('WebSocket connected for device updates');
    };
    
    ws.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            handleSensorUpdate(data.data);
        } catch (error) {
            console.error('Error parsing WebSocket message:', error);
        }
    };
    
    ws.onclose = function() {
        console.log('WebSocket disconnected, reconnecting in 5 seconds...');
        setTimeout(initWebSocket, 5000);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
}

// Start WebSocket connection
if (typeof WebSocket !== 'undefined') {
    initWebSocket();
}
</script>
{% endblock %}