{% extends 'web_base.html' %}
{% load static %}

{% block content %}
    <br>
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="mb-0">Farm Assignment Management</h4>
                <div class="page-title-right">
                    <button class="btn btn-primary" id="addAssignmentBtn">
                        <i class="fas fa-plus me-1"></i> Assign Farms
                    </button>
                </div>
            </div>
        </div>
    </div>
    <br>

    <!-- Stats Cards -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card card-h-30">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Assignments</span>
                            <h4 class="mb-3" id="totalAssignments">0</h4>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-tasks text-primary h2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-h-30">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Assigned Staff</span>
                            <h4 class="mb-3" id="assignedStaff">0</h4>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-users text-success h2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-h-30">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Available Farms</span>
                            <h4 class="mb-3" id="availableFarms">0</h4>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-tractor text-warning h2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card card-h-30">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <span class="text-muted mb-3 lh-1 d-block text-truncate">Today's Assignments</span>
                            <h4 class="mb-3" id="todayAssignments">0</h4>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-calendar-day text-info h2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>

    <!-- Main Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="assignmentTable" class="table table-striped datatable" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Assignment ID</th>
                                    <th>Staff Name</th>
                                    <th>Staff ID</th>
                                    <th>Farm Reference</th>
                                    <th>Farmer Name</th>
                                    <th>Region</th>
                                    <th>District</th>
                                    <th>Assigned Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Farms Modal -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header  text-white">
                    <h5 class="modal-title" id="modalTitle">Assign Farms to Staff</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="assignmentForm" method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="staff_select" class="form-label">Select Staff *</label>
                                    <select class="form-select" id="staff_select" name="staff_id" required>
                                        <option value="">Select Staff Member</option>
                                        {% for staff in staff_list %}
                                            <option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name }} - {{ staff.staffid }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Please select a staff member</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="staff_details" class="form-label">Staff Details</label>
                                    <div class="card bg-light p-2">
                                        <small id="staffDetails" class="text-muted">Select a staff member to view details</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="farm_search" class="form-label">Search Available Farms</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="farm_search" placeholder="Search by farm reference, farmer name, location...">
                                        <button class="btn btn-outline-secondary" type="button" id="refreshFarmsBtn">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Available Farms for Assignment</h6>
                                    </div>
                                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                        <div id="farmList" class="list-group">
                                            <!-- Farms will be loaded here -->
                                            <div class="text-center py-3">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2">Loading available farms...</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <small class="text-muted" id="selectedCount">0 farms selected</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="form-group">
                                    <label for="assignment_notes" class="form-label">Assignment Notes (Optional)</label>
                                    <textarea class="form-control" id="assignment_notes" name="assignment_notes" rows="2" placeholder="Add any notes for this assignment..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveAssignmentBtn">Assign Selected Farms</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Assignment Details Modal -->
    <div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header  text-white">
                    <h5 class="modal-title">Assignment Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="assignmentDetails">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="printAssignmentBtn">
                        <i class="fas fa-print me-1"></i> Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header  text-white">
                    <h5 class="modal-title">Confirm Unassignment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to remove this farm assignment? This action cannot be undone.</p>
                    <div class="form-group">
                        <label for="deleteReason" class="form-label">Reason for unassignment:</label>
                        <textarea class="form-control" id="deleteReason" rows="3" placeholder="Enter reason for unassigning this farm..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Unassign Farm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Required CSS and JS links -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    $(document).ready(function() {
        // Initialize DataTable
        var assignmentTable = $('#assignmentTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{% url 'farm_assignment_api' %}",
                type: "GET"
            },
            columns: [
                { data: 'assignment_id' },
                { data: 'staff_name' },
                { data: 'staff_id' },
                { data: 'farm_reference' },
                { data: 'farmer_name' },
                { data: 'region' },
                { data: 'district' },
                { data: 'assigned_date' },
                {
                    data: 'id',
                    render: function(data, type, row) {
                        return `
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-info view-assignment" data-id="${data}" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-danger delete-assignment" data-id="${data}" title="Unassign">
                                    <i class="fas fa-unlink"></i>
                                </button>
                            </div>
                        `;
                    },
                    orderable: false,
                    searchable: false
                }
            ],
            order: [[7, 'desc']],
            buttons: [
                {
                    extend: "copy",
                    text: '<i class="fas fa-copy"></i> Copy',
                    className: "btn btn-sm btn-outline-secondary",
                },
                {
                    extend: "csv",
                    text: '<i class="fas fa-file-csv"></i> CSV',
                    className: "btn btn-sm btn-outline-success",
                },
                {
                    extend: "excel",
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    className: "btn btn-sm btn-outline-primary",
                },
                {
                    extend: "pdf",
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    className: "btn btn-sm btn-outline-danger",
                },
                {
                    extend: "print",
                    text: '<i class="fas fa-print"></i> Print',
                    className: "btn btn-sm btn-outline-info",
                }
            ],
            dom: 'Bfrtip',
            language: {
                emptyTable: "No farm assignments found",
                zeroRecords: "No matching assignments found"
            },
            drawCallback: function(settings) {
                updateStats();
            }
        });

        // Initialize Select2 for staff selection
        $('#staff_select').select2({
            placeholder: "Select Staff Member",
            allowClear: true,
            width: '100%'
        });

        // Load available farms
        function loadAvailableFarms(search = '') {
            $.ajax({
                url: "{% url 'get_available_farms' %}",
                type: "GET",
                data: { search: search },
                beforeSend: function() {
                    $('#farmList').html(`
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading available farms...</p>
                        </div>
                    `);
                },
                success: function(response) {
                    if (response.success) {
                        var farms = response.farms;
                        if (farms.length === 0) {
                            $('#farmList').html(`
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No available farms found. All farms may already be assigned.
                                </div>
                            `);
                        } else {
                            var html = '';
                            farms.forEach(function(farm) {
                                html += `
                                    <div class="list-group-item">
                                        <div class="form-check">
                                            <input class="form-check-input farm-checkbox" type="checkbox" value="${farm.id}" id="farm_${farm.id}">
                                            <label class="form-check-label w-100" for="farm_${farm.id}">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>${farm.farm_reference}</strong>
                                                        <div class="text-muted small">
                                                            Farmer: ${farm.farmer_name} | Location: ${farm.location}
                                                        </div>
                                                        <div class="text-muted small">
                                                            Region: ${farm.region} | District: ${farm.district}
                                                        </div>
                                                    </div>
                                                    <span class="badge bg-${farm.status === 'Treatment' ? 'success' : farm.status === 'Establishment' ? 'info' : 'warning'}">
                                                        ${farm.status}
                                                    </span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#farmList').html(html);
                            updateSelectedCount();
                        }
                    }
                },
                error: function() {
                    $('#farmList').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to load available farms. Please try again.
                        </div>
                    `);
                }
            });
        }

        // Update selected farm count
        function updateSelectedCount() {
            var count = $('.farm-checkbox:checked').length;
            $('#selectedCount').text(count + ' farm(s) selected');
        }

        // Load staff details
        function loadStaffDetails(staffId) {
            $.ajax({
                url: "{% url 'get_available_staff' %}",
                type: "GET",
                success: function(response) {
                    if (response.success) {
                        var staff = response.staff.find(s => s.id == staffId);
                        if (staff) {
                            $('#staffDetails').html(`
                                <strong>${staff.staff_name}</strong><br>
                                <small>ID: ${staff.staff_id}</small><br>
                                <small>Designation: ${staff.designation}</small><br>
                                <small>Contact: ${staff.contact}</small>
                            `);
                        }
                    }
                }
            });
        }

        // Update statistics
        function updateStats() {
            $.ajax({
                url: "{% url 'farm_assignment_api' %}",
                type: "GET",
                data: { draw: 1, start: 0, length: 1000 },
                success: function(response) {
                    var data = response.data;
                    
                    // Get unique staff members
                    var staffSet = new Set();
                    data.forEach(function(item) {
                        staffSet.add(item.staff_name);
                    });
                    
                    // Count today's assignments (you may need to adjust this logic)
                    var today = new Date().toISOString().split('T')[0];
                    var todayAssignments = data.filter(function(item) {
                        return item.assigned_date.startsWith(today);
                    }).length;
                    
                    $('#totalAssignments').text(data.length);
                    $('#assignedStaff').text(staffSet.size);
                    $('#todayAssignments').text(todayAssignments);
                    
                    // Get available farms count
                    $.ajax({
                        url: "{% url 'get_available_farms' %}",
                        type: "GET",
                        success: function(farmResponse) {
                            if (farmResponse.success) {
                                $('#availableFarms').text(farmResponse.farms.length);
                            }
                        }
                    });
                }
            });
        }

        // Add Assignment Button
        $('#addAssignmentBtn').click(function() {
            $('#assignmentForm')[0].reset();
            $('#modalTitle').text('Assign Farms to Staff');
            $('#staff_select').val('').trigger('change');
            $('#staffDetails').text('Select a staff member to view details');
            $('#farm_search').val('');
            loadAvailableFarms();
            $('#assignmentModal').modal('show');
        });

        // Refresh farms button
        $('#refreshFarmsBtn').click(function() {
            loadAvailableFarms($('#farm_search').val());
        });

        // Farm search
        $('#farm_search').on('keyup', function() {
            loadAvailableFarms($(this).val());
        });

        // Farm checkbox selection
        $(document).on('change', '.farm-checkbox', function() {
            updateSelectedCount();
        });

        // Staff selection change
        $('#staff_select').on('change', function() {
            var staffId = $(this).val();
            if (staffId) {
                loadStaffDetails(staffId);
            } else {
                $('#staffDetails').text('Select a staff member to view details');
            }
        });

        // Form Submission
        $('#assignmentForm').submit(function(e) {
            e.preventDefault();
            
            if (!this.checkValidity()) {
                e.stopPropagation();
                $(this).addClass('was-validated');
                return;
            }
            
            var staffId = $('#staff_select').val();
            var selectedFarms = [];
            $('.farm-checkbox:checked').each(function() {
                selectedFarms.push($(this).val());
            });
            
            if (selectedFarms.length === 0) {
                Swal.fire('Error', 'Please select at least one farm to assign', 'error');
                return;
            }
            
            var formData = {
                staff_id: staffId,
                farm_ids: selectedFarms,
                notes: $('#assignment_notes').val()
            };
            
            $.ajax({
                url: "{% url 'create_assignment' %}",
                type: "POST",
                contentType: 'application/json',
                data: JSON.stringify(formData),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                beforeSend: function() {
                    $('#saveAssignmentBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Assigning...');
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Success', response.message, 'success');
                        $('#assignmentModal').modal('hide');
                        assignmentTable.ajax.reload();
                        updateStats();
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'An error occurred';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || errorMsg;
                    } catch(e) {
                        errorMsg = xhr.statusText || errorMsg;
                    }
                    Swal.fire('Error', errorMsg, 'error');
                },
                complete: function() {
                    $('#saveAssignmentBtn').prop('disabled', false).html('Assign Selected Farms');
                }
            });
        });

        // View Assignment
        $(document).on('click', '.view-assignment', function() {
            var assignmentId = $(this).data('id');
            
            $.ajax({
                url: `/api/assignment-details/${assignmentId}/`,
                type: 'GET',
                beforeSend: function() {
                    $('#assignmentDetails').html(`
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading assignment details...</p>
                        </div>
                    `);
                },
                success: function(response) {
                    if (response.success) {
                        var assignment = response.data;
                        var html = `
                            <div class="assignment-details">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Assignment Reference</h6>
                                        <p class="fw-bold">${assignment.assignment_ref}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Assigned Date</h6>
                                        <p class="fw-bold">${assignment.assigned_date}</p>
                                    </div>
                                </div>
                                <hr>
                                <h5 class="mb-3">Staff Information</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Staff Name</h6>
                                        <p class="fw-bold">${assignment.staff_name}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Staff ID</h6>
                                        <p class="fw-bold">${assignment.staff_id}</p>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Designation</h6>
                                        <p class="fw-bold">${assignment.staff_designation}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Contact</h6>
                                        <p class="fw-bold">${assignment.staff_contact}</p>
                                    </div>
                                </div>
                                <hr>
                                <h5 class="mb-3">Farm Information</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Farm Reference</h6>
                                        <p class="fw-bold">${assignment.farm_reference}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted">Farmer Name</h6>
                                        <p class="fw-bold">${assignment.farmer_name}</p>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Region</h6>
                                        <p class="fw-bold">${assignment.region}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">District</h6>
                                        <p class="fw-bold">${assignment.district}</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Location</h6>
                                        <p class="fw-bold">${assignment.location}</p>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Farm Size</h6>
                                        <p class="fw-bold">${assignment.farm_size} acres</p>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Status</h6>
                                        <p><span class="badge bg-${assignment.farm_status === 'Treatment' ? 'success' : assignment.farm_status === 'Establishment' ? 'info' : 'warning'}">${assignment.farm_status}</span></p>
                                    </div>
                                    <div class="col-md-4">
                                        <h6 class="text-muted">Year Established</h6>
                                        <p class="fw-bold">${assignment.year_established}</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-12">
                                        <h6 class="text-muted">Assignment Notes</h6>
                                        <p class="fw-bold">${assignment.assignment_notes || 'No notes provided'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        $('#assignmentDetails').html(html);
                        $('#viewModal').modal('show');
                    } else {
                        $('#assignmentDetails').html(`
                            <div class="alert alert-danger">
                                Failed to load assignment details: ${response.message}
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('#assignmentDetails').html(`
                        <div class="alert alert-danger">
                            Failed to load assignment details
                        </div>
                    `);
                }
            });
        });

        // Delete Assignment
        var deleteAssignmentId = null;
        $(document).on('click', '.delete-assignment', function() {
            deleteAssignmentId = $(this).data('id');
            $('#deleteReason').val('');
            $('#deleteModal').modal('show');
        });

        $('#confirmDeleteBtn').click(function() {
            var reason = $('#deleteReason').val();
            if (!reason.trim()) {
                Swal.fire('Error', 'Please provide a reason for unassignment', 'error');
                return;
            }
            
            $.ajax({
                url: `/api/delete-assignment/${deleteAssignmentId}/`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ reason: reason }),
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                beforeSend: function() {
                    $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Unassigning...');
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Success', response.message, 'success');
                        $('#deleteModal').modal('hide');
                        assignmentTable.ajax.reload();
                        updateStats();
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: function(xhr) {
                    var errorMsg = 'An error occurred';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || errorMsg;
                    } catch(e) {
                        errorMsg = xhr.statusText || errorMsg;
                    }
                    Swal.fire('Error', errorMsg, 'error');
                },
                complete: function() {
                    $('#confirmDeleteBtn').prop('disabled', false).html('Unassign Farm');
                }
            });
        });

        // Print Assignment Details
        $('#printAssignmentBtn').click(function() {
            var printContent = $('#assignmentDetails').html();
            var originalContent = $('body').html();
            
            $('body').html(`
                <div class="container mt-5">
                    <h2 class="text-center mb-4">Farm Assignment Report</h2>
                    <div class="mb-4 text-center">
                        <small>Report generated on: ${new Date().toLocaleString()}</small>
                    </div>
                    ${printContent}
                    <div class="mt-5 text-center">
                        <hr>
                        <small class="text-muted">Confidential - For internal use only</small>
                    </div>
                </div>
            `);
            
            window.print();
            $('body').html(originalContent);
            $('#viewModal').modal('show');
        });

        // CSRF Token helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initial load
        updateStats();
    });
    </script>

    <style>
    .card-h-30 {
        height: 130px;
    }
    
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .assignment-details h6 {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .assignment-details p {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .badge {
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 600;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    #farmList {
        max-height: 300px;
        overflow-y: auto;
    }
    
    @media print {
        .modal-header, .modal-footer, .btn {
            display: none !important;
        }
        
        .modal-dialog {
            max-width: 100% !important;
            margin: 0 !important;
        }
        
        .modal-content {
            border: none !important;
            box-shadow: none !important;
        }
        
        .modal-body {
            padding: 0 !important;
        }
        
        hr {
            border-top: 1px solid #000 !important;
        }
    }
    </style>
{% endblock %}