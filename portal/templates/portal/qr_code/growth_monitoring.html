<!-- templates/growth_monitoring/growth_monitoring_optimized.html -->
{% extends 'web_base.html' %}
{% load static %}

{% block title %}Growth Monitoring{% endblock %}

{% block content %}

<style>
/* Page-specific styles - OPTIMIZED */
:root {
    --primary-color: #28a745;
    --secondary-color: #6c757d;
}

* {
    box-sizing: border-box;
}

.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.stat-card {
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

/* QR Code preview */
.qr-preview {
    max-width: 80px;
    max-height: 80px;
    cursor: pointer;
}

/* Map container - fixed height to prevent layout shifts */
#locationMap, #viewMap {
    height: 250px;
    width: 100%;
    border-radius: 8px;
}

/* DataTables optimization */
.dataTables_wrapper {
    overflow-x: auto;
}

.dt-buttons {
    margin-bottom: 10px;
}

.dt-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Table optimization */
.table {
    font-size: 0.85rem;
}

.table td, .table th {
    padding: 0.5rem;
    white-space: nowrap;
}

/* Badge styles */
.badge {
    padding: 0.25em 0.5em;
    font-size: 0.7em;
}

/* Modal optimization */
.modal-xl {
    max-width: 90%;
}

@media (min-width: 1200px) {
    .modal-xl {
        max-width: 1000px;
    }
}

/* Form optimization */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.form-control, .form-select {
    font-size: 0.9rem;
    padding: 0.375rem 0.5rem;
}

/* Hide ApexCharts */
.apexcharts-canvas {
    display: none !important;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Chart containers - fixed height */
#growthTrendChart, #leafColorChart {
    max-height: 250px;
    width: 100%;
}
</style>

<!-- Load only essential CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<br>
<!-- Page Header -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <h4 class="mb-0">
                <i class="fas fa-leaf text-success me-2"></i>
                Growth Monitoring
            </h4>
            <div class="page-title-right">
                <button class="btn btn-primary btn-sm" id="addRecordBtn">
                    <i class="fas fa-plus me-1"></i> Add Record
                </button>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Stats Cards - Simplified -->
<div class="row">
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted small">Total Records</span>
                        <h4 class="mb-0" id="totalRecords">0</h4>
                    </div>
                    <div class="stat-icon bg-primary bg-opacity-10">
                        <i class="fas fa-database text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted small">Today</span>
                        <h4 class="mb-0" id="todayRecords">0</h4>
                    </div>
                    <div class="stat-icon bg-info bg-opacity-10">
                        <i class="fas fa-calendar-day text-info"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted small">Avg Height</span>
                        <h4 class="mb-0" id="avgHeight">0cm</h4>
                    </div>
                    <div class="stat-icon bg-warning bg-opacity-10">
                        <i class="fas fa-arrow-up text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="card-body p-3">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted small">Avg Stem</span>
                        <h4 class="mb-0" id="avgStemSize">0cm</h4>
                    </div>
                    <div class="stat-icon bg-secondary bg-opacity-10">
                        <i class="fas fa-circle text-secondary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row - Hidden by default, load on demand -->
<div class="row" id="chartsContainer" style="display: none;">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0">Growth Trend</h6>
            </div>
            <div class="card-body p-2">
                <canvas id="growthTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0">Leaf Color</h6>
            </div>
            <div class="card-body p-2">
                <canvas id="leafColorChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Filters - Compact -->
<!-- <div class="row mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-2">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="date" class="form-control form-control-sm" id="startDate" placeholder="Start">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control form-control-sm" id="endDate" placeholder="End">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="filterDistrict">
                            <option value="">District</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="filterAgent">
                            <option value="">Officer</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="d-flex gap-1">
                            <button class="btn btn-primary btn-sm flex-grow-1" id="applyFilters">
                                <i class="fas fa-filter"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="resetFilters">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!-- Main Table - Optimized -->
<div class="row mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-2">
                <div class="table-responsive">
                    <table id="growthTable" class="table table-striped table-sm" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Plant UID</th>
                                <th>Officer</th>
                                <th>Height</th>
                                <th>Stem</th>
                                <th>Leaves</th>
                                <th>Color</th>
                                <th>District</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal - Simplified -->
<div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title" id="modalTitle">Add Growth Record</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="recordForm">
                <div class="modal-body p-3">
                    <input type="hidden" id="recordId">
                    <input type="hidden" id="uid">
                    
                    <div class="row g-2">
                        <div class="col-md-6">
                            <label class="form-label">Plant UID *</label>
                            <input type="text" class="form-control form-control-sm" id="plant_uid" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">QR Code</label>
                            <select class="form-select form-select-sm" id="qr_code">
                                <option value="">Select QR Code</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Height (cm) *</label>
                            <input type="number" class="form-control form-control-sm" id="height" step="0.1" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Stem (cm) *</label>
                            <input type="number" class="form-control form-control-sm" id="stem_size" step="0.1" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Leaves *</label>
                            <input type="number" class="form-control form-control-sm" id="number_of_leaves" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Leaf Color *</label>
                            <select class="form-select form-select-sm" id="leaf_color" required>
                                <option value="">Select</option>
                                <option value="Green">Green</option>
                                <option value="Light Green">Light Green</option>
                                <option value="Dark Green">Dark Green</option>
                                <option value="Yellowish">Yellowish</option>
                                <option value="Brown">Brown</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-control form-control-sm" id="date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Latitude *</label>
                            <input type="number" class="form-control form-control-sm" id="lat" step="any" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Longitude *</label>
                            <input type="number" class="form-control form-control-sm" id="lng" step="any" required>
                        </div>
                        <div class="col-12">
                            <div id="locationMap" style="height: 200px;"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">District</label>
                            <select class="form-select form-select-sm" id="district_id">
                                <option value="">Select</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Project Officer</label>
                            <select class="form-select form-select-sm" id="agent_id">
                                <option value="">Select</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sm btn-success" id="saveBtn">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Modal - Simplified -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white py-2">
                <h6 class="modal-title">Growth Record Details</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3" id="recordDetails"></div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" id="editFromViewBtn">Edit</button>
                <button type="button" class="btn btn-sm btn-danger" id="deleteFromViewBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white py-2">
                <h6 class="modal-title">Confirm Delete</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <p>Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>


<!-- Growth History Modal -->
<div class="modal fade" id="growthHistoryModal" tabindex="-1" aria-labelledby="growthHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="growthHistoryModalLabel">
                    <i class="fas fa-chart-line me-2"></i>
                    Plant Growth History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading Spinner -->
                <div id="growthHistoryLoading" class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading growth history...</p>
                </div>
                
                <!-- Content Container (Hidden by default) -->
                <div id="growthHistoryContent" style="display: none;">
                    <!-- Plant Info Header -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-qrcode fa-2x text-success"></i>
                                </div>
                                <div>
                                    <h4 id="plantUidDisplay" class="mb-1">ACL-PLT-2026-0823-00087</h4>
                                    <p class="text-muted mb-0">
                                        <span id="plantDistrictDisplay">District</span> • 
                                        <span id="plantMeasurementsCount">0</span> measurements over 
                                        <span id="plantMonitoringDays">0</span> days
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body py-2 px-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-muted small">Current Health</span>
                                        <span id="currentHealthBadge" class="badge bg-success">Excellent</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <span class="text-muted small">Health Score</span>
                                        <span id="currentHealthScore" class="fw-bold">85%</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-1">
                                        <span class="text-muted small">Trend</span>
                                        <span id="healthTrendDisplay">
                                            <i class="fas fa-arrow-up text-success"></i> +5%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Metrics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <span class="text-muted small text-uppercase">Height</span>
                                            <h3 id="currentHeight" class="mb-0">0.0 <small class="fw-normal fs-6">cm</small></h3>
                                            <small id="heightProgress" class="text-success">
                                                <i class="fas fa-arrow-up"></i> +0.0cm
                                            </small>
                                        </div>
                                        <div class="stat-icon bg-primary bg-opacity-10">
                                            <i class="fas fa-arrow-up text-primary"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <span class="text-muted small text-uppercase">Leaves</span>
                                            <h3 id="currentLeaves" class="mb-0">0</h3>
                                            <small id="leavesProgress" class="text-success">
                                                <i class="fas fa-arrow-up"></i> +0
                                            </small>
                                        </div>
                                        <div class="stat-icon bg-success bg-opacity-10">
                                            <i class="fas fa-leaf text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <span class="text-muted small text-uppercase">Stem Size</span>
                                            <h3 id="currentStem" class="mb-0">0.0 <small class="fw-normal fs-6">cm</small></h3>
                                            <small id="stemProgress" class="text-success">
                                                <i class="fas fa-arrow-up"></i> +0.0cm
                                            </small>
                                        </div>
                                        <div class="stat-icon bg-warning bg-opacity-10">
                                            <i class="fas fa-circle text-warning"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card h-100">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <span class="text-muted small text-uppercase">Leaf Color</span>
                                            <h3 id="currentLeafColor" class="mb-0">Green</h3>
                                            <small id="lastMeasured" class="text-muted">Today</small>
                                        </div>
                                        <div class="stat-icon bg-info bg-opacity-10">
                                            <i class="fas fa-palette text-info"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Growth Charts - Full Width -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <ul class="nav nav-tabs card-header-tabs" id="chartTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="height-tab" data-bs-toggle="tab" data-bs-target="#heightChart" type="button" role="tab">
                                                <i class="fas fa-arrow-up me-1"></i> Height
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="leaves-tab" data-bs-toggle="tab" data-bs-target="#leavesChart" type="button" role="tab">
                                                <i class="fas fa-leaf me-1"></i> Leaves
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="stem-tab" data-bs-toggle="tab" data-bs-target="#stemChart" type="button" role="tab">
                                                <i class="fas fa-circle me-1"></i> Stem
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="health-tab" data-bs-toggle="tab" data-bs-target="#healthChart" type="button" role="tab">
                                                <i class="fas fa-heartbeat me-1"></i> Health
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="chartTabContent">
                                        <div class="tab-pane fade show active" id="heightChart" role="tabpanel">
                                            <canvas id="heightHistoryChart" style="height: 300px; width: 100%;"></canvas>
                                        </div>
                                        <div class="tab-pane fade" id="leavesChart" role="tabpanel">
                                            <canvas id="leavesHistoryChart" style="height: 300px; width: 100%;"></canvas>
                                        </div>
                                        <div class="tab-pane fade" id="stemChart" role="tabpanel">
                                            <canvas id="stemHistoryChart" style="height: 300px; width: 100%;"></canvas>
                                        </div>
                                        <div class="tab-pane fade" id="healthChart" role="tabpanel">
                                            <canvas id="healthHistoryChart" style="height: 300px; width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Officer History & Measurements - Full Width -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Measurements</h6>
                                    <span class="badge bg-success" id="totalMeasurements">0</span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Height (cm)</th>
                                                    <th>Leaves</th>
                                                    <th>Stem (cm)</th>
                                                    <th>Leaf Color</th>
                                                    <!-- <th>Health Score</th>
                                                    <th>Officer</th> -->
                                                </tr>
                                            </thead>
                                            <tbody id="measurementHistoryTable">
                                                <!-- Dynamically populated -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Map - Full Width -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Plant Location</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="plantLocationMap" style="height: 350px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="printGrowthHistory">
                    <i class="fas fa-print me-1"></i> Print Report
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Additional styles for full-width layout */
#growthHistoryModal .modal-body {
    max-height: 80vh;
    overflow-y: auto;
    padding: 1.5rem;
}

#growthHistoryModal .card {
    border: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    margin-bottom: 0;
}

#growthHistoryModal .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    padding: 0.75rem 1rem;
}

#growthHistoryModal .nav-tabs .nav-link {
    padding: 0.5rem 1.25rem;
    font-size: 0.9rem;
}

#growthHistoryModal .table th {
    background-color: #f8f9fa;
    font-size: 0.8rem;
    font-weight: 600;
    color: #495057;
    border-bottom-width: 1px;
    padding: 0.6rem 0.5rem;
}

#growthHistoryModal .table td {
    padding: 0.5rem;
    vertical-align: middle;
    font-size: 0.85rem;
}

#growthHistoryModal .table-responsive {
    max-height: 300px;
    overflow-y: auto;
}

#growthHistoryModal .stat-card {
    transition: transform 0.2s;
    border: 1px solid rgba(0,0,0,0.05);
    height: 100%;
}

#growthHistoryModal .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

#growthHistoryModal .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

/* Ensure charts are responsive */
#growthHistoryModal canvas {
    max-width: 100%;
    height: auto !important;
}

/* Make modal full width on larger screens */
@media (min-width: 1400px) {
    #growthHistoryModal .modal-xl {
        max-width: 1300px;
    }
}

/* Improve spacing */
#growthHistoryModal .row {
    margin-left: -0.5rem;
    margin-right: -0.5rem;
}

#growthHistoryModal .col-12,
#growthHistoryModal .col-md-3,
#growthHistoryModal .col-md-4,
#growthHistoryModal .col-md-8 {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
}

/* Badge styling */
#growthHistoryModal .badge {
    padding: 0.35em 0.65em;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Progress bar styling */
#growthHistoryModal .progress {
    background-color: #e9ecef;
    border-radius: 4px;
    height: 6px;
}

/* Health badge colors */
.bg-success { background-color: #28a745 !important; }
.bg-info { background-color: #17a2b8 !important; }
.bg-warning { background-color: #ffc107 !important; }
.bg-danger { background-color: #dc3545 !important; }
</style>

<!-- Load scripts at the end for better performance -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Optimized JavaScript
$(document).ready(function() {
    // API URLs
    const urls = {
        list: "/api/growth-monitoring/list/",
        create: "/api/growth-monitoring/create/",
        detail: "/api/growth-monitoring/",
        update: "/api/growth-monitoring/",
        delete: "/api/growth-monitoring/",
        stats: "/api/growth-monitoring/stats/",
        qrCodes: "/api/growth-monitoring/qr-codes/"
    };
    
    // Global variables
    let map = null;
    let marker = null;
    let currentRecordId = null;
    let growthTable = null;
    
    // Chart instances for growth history
    let heightChart = null;
    let leavesChart = null;
    let stemChart = null;
    let healthChart = null;
    let progressChart = null;
    let plantMap = null;
    let currentChartData = null;
    let isProgressChartInitialized = false;
    let isModalLoaded = false;
    let chartTabsBound = false; // Flag to track if tab events are bound
    
    // Initialize map
    function initMap(lat = 6.5, lng = -0.5) {
        if (!map) {
            map = L.map('locationMap').setView([lat, lng], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
        }
        
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);
    }
    
    // Initialize DataTable with optimized settings
    growthTable = $('#growthTable').DataTable({
        processing: true,
        serverSide: true,
        pageLength: 10,
        lengthMenu: [10, 25, 50],
        ajax: {
            url: urls.list,
            type: "GET",
            data: function(d) {
                d.start_date = $('#startDate').val();
                d.end_date = $('#endDate').val();
                d.district_id = $('#filterDistrict').val();
                d.agent_id = $('#filterAgent').val();
            }
        },
        columns: [
            { 
                data: 'id',
                render: data => data ? `GM-${String(data).slice(-4)}` : 'N/A'
            },
            { data: 'date' },
            { 
                data: 'plant_uid',
                render: data => data ? data.substring(0, 40) + '...' : 'N/A'
            },
            { 
                data: 'agent_name',
                render: data => data ? data.substring(0, 15) : 'N/A'
            },
            { 
                data: 'height',
                render: data => data ? `${parseFloat(data).toFixed(1)}` : '0'
            },
            { 
                data: 'stem_size',
                render: data => data ? `${parseFloat(data).toFixed(1)}` : '0'
            },
            { data: 'number_of_leaves' },
            { 
                data: 'leaf_color',
                render: data => {
                    const colors = {Green: 'success', 'Light Green': 'success', 'Dark Green': 'success', Yellowish: 'warning', Brown: 'secondary'};
                    return `<span class="badge bg-${colors[data] || 'secondary'}">${data || 'N/A'}</span>`;
                }
            },
            { 
                data: 'district_name',
                render: data => data ? data.substring(0, 15) : 'N/A'
            },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `<div class="btn-group btn-group-sm">
                        <button class="btn btn-info view-record" data-id="${data}" title="View" style="display: none"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-success growth-history" data-plant="${row.plant_uid}" data-id="${data}" title="Growth History">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        {% if request.user.is_superuser or 'Project Officer' in request.user.groups.all %}
                        <button class="btn btn-primary edit-record" data-id="${data}" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-record" data-id="${data}" title="Delete"><i class="fas fa-trash"></i></button>
                        {% endif %}
                    </div>`;
                },
                orderable: false
            }
        ],
        order: [[1, 'desc']],
        dom: 'Bfrtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
        language: {
            processing: '<div class="loading-spinner"></div>',
            emptyTable: 'No records found'
        },
        drawCallback: function() {
            $('[data-bs-toggle="tooltip"]').tooltip('dispose');
        }
    });
    
    // Load stats - simplified
    function loadStats() {
        $.ajax({
            url: urls.stats,
            type: "GET",
            success: function(response) {
                if (response?.success) {
                    const s = response.data;
                    $('#totalRecords').text(s.total_records || 0);
                    $('#todayRecords').text(s.today_records || 0);
                    $('#avgHeight').text((s.avg_height || 0).toFixed(1) + 'cm');
                    $('#avgStemSize').text((s.avg_stem_size || 0).toFixed(1) + 'cm');
                }
            }
        });
    }
    
    // Load dropdowns - cached
    let districtsLoaded = false;
    function loadDistricts() {
        if (districtsLoaded) return;
        $.ajax({
            url: "/api/get-districts/",
            type: "GET",
            success: function(response) {
                if (response?.success && response.data) {
                    const $select = $('#filterDistrict, #district_id');
                    $select.each(function() {
                        const $this = $(this);
                        $this.find('option:not(:first)').remove();
                        response.data.slice(0, 50).forEach(d => {
                            $this.append(`<option value="${d.id}">${d.name.substring(0, 30)}</option>`);
                        });
                    });
                    districtsLoaded = true;
                }
            }
        });
    }
    
    // Load project officers - cached
    let officersLoaded = false;
    function loadProjectOfficers() {
        if (officersLoaded) return;
        $.ajax({
            url: "/api/get-agents/",
            type: "GET",
            success: function(response) {
                if (response?.success && response.data) {
                    const $select = $('#filterAgent, #agent_id');
                    $select.each(function() {
                        const $this = $(this);
                        $this.find('option:not(:first)').remove();
                        response.data.slice(0, 50).forEach(a => {
                            $this.append(`<option value="${a.id}">${a.name.substring(0, 30)}</option>`);
                        });
                    });
                    officersLoaded = true;
                }
            }
        });
    }
    
    // Load QR codes
    function loadQRCodes() {
        $.ajax({
            url: urls.qrCodes,
            type: "GET",
            success: function(response) {
                if (response?.success && response.data) {
                    const $select = $('#qr_code');
                    $select.find('option:not(:first)').remove();
                    response.data.slice(0, 50).forEach(q => {
                        $select.append(`<option value="${q.id}">${q.uid.substring(0, 30)}</option>`);
                    });
                }
            }
        });
    }
    
    // Reset form
    function resetForm() {
        $('#recordForm')[0].reset();
        $('#recordId, #uid').val('');
        $('#date').val(new Date().toISOString().split('T')[0]);
        if (map) {
            map.setView([6.5, -0.5], 8);
            if (marker) map.removeLayer(marker);
        }
    }
    
    // ============ GROWTH HISTORY CHART FUNCTIONS ============
    
    // Clear canvas helper function
    function clearCanvas(canvasId) {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    
    // Destroy all chart instances
    function destroyCharts() {
        if (heightChart) {
            heightChart.destroy();
            heightChart = null;
        }
        if (leavesChart) {
            leavesChart.destroy();
            leavesChart = null;
        }
        if (stemChart) {
            stemChart.destroy();
            stemChart = null;
        }
        if (healthChart) {
            healthChart.destroy();
            healthChart = null;
        }
        if (progressChart) {
            progressChart.destroy();
            progressChart = null;
        }
        if (plantMap) {
            plantMap.remove();
            plantMap = null;
        }
    }
    
    // Individual chart initialization functions
    function initHeightChart() {
        if (!currentChartData) return;
        
        const canvas = document.getElementById('heightHistoryChart');
        if (!canvas) return;
        
        clearCanvas('heightHistoryChart');
        
        const ctx = canvas.getContext('2d');
        heightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentChartData.dates,
                datasets: [{
                    label: 'Height (cm)',
                    data: currentChartData.height,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function initLeavesChart() {
        if (!currentChartData) return;
        
        const canvas = document.getElementById('leavesHistoryChart');
        if (!canvas) return;
        
        clearCanvas('leavesHistoryChart');
        
        const ctx = canvas.getContext('2d');
        leavesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentChartData.dates,
                datasets: [{
                    label: 'Number of Leaves',
                    data: currentChartData.leaves,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function initStemChart() {
        if (!currentChartData) return;
        
        const canvas = document.getElementById('stemHistoryChart');
        if (!canvas) return;
        
        clearCanvas('stemHistoryChart');
        
        const ctx = canvas.getContext('2d');
        stemChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentChartData.dates,
                datasets: [{
                    label: 'Stem Size (cm)',
                    data: currentChartData.stem,
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function initHealthChart() {
        if (!currentChartData) return;
        
        const canvas = document.getElementById('healthHistoryChart');
        if (!canvas) return;
        
        clearCanvas('healthHistoryChart');
        
        const ctx = canvas.getContext('2d');
        healthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: currentChartData.dates,
                datasets: [{
                    label: 'Health Score',
                    data: currentChartData.health,
                    borderColor: '#6f42c1',
                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: { mode: 'index', intersect: false },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    
    function initProgressChart() {
        if (!currentChartData) return;
        
        const canvas = document.getElementById('growthProgressChart');
        if (!canvas) return;
        
        clearCanvas('growthProgressChart');
        
        const ctx = canvas.getContext('2d');
        const lastHeight = currentChartData.height[currentChartData.height.length - 1] || 0;
        const targetHeight = 100;
        const progressPercent = Math.min((lastHeight / targetHeight) * 100, 100);
        
        progressChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Progress', 'Remaining'],
                datasets: [{
                    data: [progressPercent, 100 - progressPercent],
                    backgroundColor: ['#28a745', '#e9ecef'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                animation: {
                    duration: 0
                }
            }
        });
    }
    
    // Initialize ONLY the active tab's chart
    function initializeActiveTabChart() {
        if (!currentChartData) return;
        
        const activeTab = $('#chartTabs .nav-link.active').attr('id');
        
        if (activeTab === 'height-tab') {
            if (heightChart) {
                heightChart.destroy();
                heightChart = null;
            }
            initHeightChart();
        } else if (activeTab === 'leaves-tab') {
            if (leavesChart) {
                leavesChart.destroy();
                leavesChart = null;
            }
            initLeavesChart();
        } else if (activeTab === 'stem-tab') {
            if (stemChart) {
                stemChart.destroy();
                stemChart = null;
            }
            initStemChart();
        } else if (activeTab === 'health-tab') {
            if (healthChart) {
                healthChart.destroy();
                healthChart = null;
            }
            initHealthChart();
        }
    }
    
    // Display Officer History
    function displayOfficerHistory(officers) {
        let html = '';
        
        if (Object.keys(officers).length === 0) {
            html = '<div class="list-group-item text-center text-muted">No officer history available</div>';
        } else {
            Object.entries(officers).forEach(([name, stats]) => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user-circle text-success me-2"></i>
                                <strong>${name}</strong>
                            </div>
                            <span class="badge bg-success rounded-pill">${stats.count} measurements</span>
                        </div>
                        <div class="mt-2 small">
                            <div class="d-flex justify-content-between text-muted">
                                <span>Avg Height: ${stats.avg_height} cm</span>
                                <span>Avg Health: ${stats.avg_health}%</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        $('#officerHistoryList').html(html);
    }
    
    // Display Measurement History
    function displayMeasurementHistory(measurements) {
        let html = '';
        
        if (measurements.length === 0) {
            html = '<tr><td colspan="5" class="text-center text-muted py-3">No measurement history available</td></tr>';
        } else {
            measurements.slice(0, 8).forEach(m => {
                const healthColor = m.health_score >= 80 ? 'success' :
                                  m.health_score >= 60 ? 'info' :
                                  m.health_score >= 40 ? 'warning' : 'danger';
                
                html += `
                    <tr>
                        <td>${m.date}</td>
                        <td>${m.height} cm</td>
                        <td>${m.leaves}</td>
                        <td><span class="badge bg-${healthColor}">${m.health_score}%</span></td>
                        <td><small>${m.officer.split(' ').slice(0, 2).join(' ') || 'N/A'}</small></td>
                    </tr>
                `;
            });
        }
        
        $('#measurementHistoryTable').html(html);
    }
    
    // Initialize Plant Location Map
    function initPlantMap(location) {
        if (!location || !location.lat || !location.lng) return;
        
        setTimeout(() => {
            if (plantMap) {
                plantMap.remove();
                plantMap = null;
            }
            
            plantMap = L.map('plantLocationMap').setView([location.lat, location.lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(plantMap);
            
            L.marker([location.lat, location.lng]).addTo(plantMap)
                .bindPopup(`
                    <strong>Plant Location</strong><br>
                    Lat: ${location.lat.toFixed(4)}<br>
                    Lng: ${location.lng.toFixed(4)}
                `)
                .openPopup();
        }, 200);
    }
    
    // Display Growth History Data
    function displayGrowthHistory(data) {
        // Plant Info
        $('#plantUidDisplay').text(data.plant_info.plant_uid);
        $('#plantDistrictDisplay').text(data.plant_info.district);
        $('#plantMeasurementsCount').text(data.plant_info.total_measurements);
        $('#plantMonitoringDays').text(data.plant_info.monitoring_days);
        $('#totalMeasurements').text(data.plant_info.total_measurements);
        
        // Current Health
        $('#currentHealthBadge')
            .text(data.current_metrics.health_status)
            .removeClass('bg-success bg-info bg-warning bg-danger')
            .addClass(`bg-${data.current_metrics.health_color}`);
        $('#currentHealthScore').text(data.current_metrics.health_score + '%');
        
        const trendIcon = data.current_metrics.health_trend > 0 ? 'arrow-up text-success' : 
                         (data.current_metrics.health_trend < 0 ? 'arrow-down text-danger' : 'minus text-muted');
        $('#healthTrendDisplay').html(`
            <i class="fas fa-${trendIcon}"></i> 
            ${data.current_metrics.health_trend > 0 ? '+' : ''}${data.current_metrics.health_trend}%
        `);
        
        // Current Metrics
        $('#currentHeight').html(`${data.current_metrics.height} <small class="fw-normal fs-6">cm</small>`);
        $('#currentLeaves').text(data.current_metrics.leaves);
        $('#currentStem').html(`${data.current_metrics.stem} <small class="fw-normal fs-6">cm</small>`);
        $('#currentLeafColor').text(data.current_metrics.leaf_color);
        $('#lastMeasured').text(`Last: ${data.plant_info.last_measured}`);
        
        // Growth Progress
        const heightProgress = data.growth_progress.height_progress;
        const leavesProgress = data.growth_progress.leaves_progress;
        const stemProgress = data.growth_progress.stem_progress;
        
        $('#heightProgress').html(`
            <i class="fas fa-arrow-${heightProgress >= 0 ? 'up' : 'down'} text-${heightProgress >= 0 ? 'success' : 'danger'}"></i> 
            ${heightProgress > 0 ? '+' : ''}${heightProgress}cm
        `);
        $('#leavesProgress').html(`
            <i class="fas fa-arrow-${leavesProgress >= 0 ? 'up' : 'down'} text-${leavesProgress >= 0 ? 'success' : 'danger'}"></i> 
            ${leavesProgress > 0 ? '+' : ''}${leavesProgress}
        `);
        $('#stemProgress').html(`
            <i class="fas fa-arrow-${stemProgress >= 0 ? 'up' : 'down'} text-${stemProgress >= 0 ? 'success' : 'danger'}"></i> 
            ${stemProgress > 0 ? '+' : ''}${stemProgress}cm
        `);
        
        // Growth Summary
        $('#totalGrowthPercent').text(data.growth_progress.height_percentage + '%');
        $('#growthProgressBar').css('width', Math.min(data.growth_progress.height_percentage, 100) + '%');
        $('#dailyHeightGrowth').text(data.growth_progress.daily_height_growth + ' cm');
        $('#dailyLeavesGrowth').text(data.growth_progress.daily_leaves_growth);
        
        // Store chart data globally
        currentChartData = data.chart_data;
        
        // Initialize ONLY the active tab chart
        initializeActiveTabChart();
        
        // Initialize progress chart ONLY ONCE
        if (!isProgressChartInitialized) {
            initProgressChart();
            isProgressChartInitialized = true;
        }
        
        // Officer History
        displayOfficerHistory(data.officer_history);
        
        // Measurement History
        displayMeasurementHistory(data.measurement_history);
        
        // Initialize Map
        initPlantMap(data.current_metrics.location);
    }
    
    // ============ EVENT HANDLERS ============
    
    // Add Record Button
    $('#addRecordBtn').click(function() {
        resetForm();
        loadQRCodes();
        loadDistricts();
        loadProjectOfficers();
        setTimeout(() => initMap(6.5, -0.5), 100);
        $('#recordModal').modal('show');
    });
    
    // Form submission
    $('#recordForm').submit(function(e) {
        e.preventDefault();
        
        const formData = {
            plant_uid: $('#plant_uid').val(),
            number_of_leaves: $('#number_of_leaves').val(),
            height: $('#height').val(),
            stem_size: $('#stem_size').val(),
            leaf_color: $('#leaf_color').val(),
            date: $('#date').val(),
            lat: $('#lat').val(),
            lng: $('#lng').val(),
            agent_id: $('#agent_id').val() || null,
            qr_code_id: $('#qr_code').val() || null,
            district_id: $('#district_id').val() || null
        };
        
        const recordId = $('#recordId').val();
        const url = recordId ? `${urls.update}${recordId}/update/` : urls.create;
        
        $.ajax({
            url: url,
            type: recordId ? 'PUT' : 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            beforeSend: () => $('#saveBtn').prop('disabled', true).html('<span class="loading-spinner"></span>'),
            success: function(response) {
                if (response?.success) {
                    Swal.fire({icon: 'success', title: 'Success', text: response.message, timer: 1500, showConfirmButton: false});
                    $('#recordModal').modal('hide');
                    growthTable.ajax.reload(null, false);
                    loadStats();
                }
            },
            error: function(xhr) {
                Swal.fire({icon: 'error', title: 'Error', text: 'Failed to save record'});
            },
            complete: () => $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Save')
        });
    });
    
    // View record
    $(document).on('click', '.view-record', function() {
        const recordId = $(this).data('id');
        
        $.ajax({
            url: `${urls.detail}${recordId}/`,
            type: 'GET',
            success: function(response) {
                if (response?.success) {
                    const r = response.data;
                    const html = `
                        <div class="row g-2">
                            <div class="col-6"><small class="text-muted">Plant UID</small><p class="mb-1">${r.plant_uid || 'N/A'}</p></div>
                            <div class="col-6"><small class="text-muted">Date</small><p class="mb-1">${r.date || 'N/A'}</p></div>
                            <div class="col-4"><small class="text-muted">Height</small><p class="mb-1">${r.height} cm</p></div>
                            <div class="col-4"><small class="text-muted">Stem</small><p class="mb-1">${r.stem_size} cm</p></div>
                            <div class="col-4"><small class="text-muted">Leaves</small><p class="mb-1">${r.number_of_leaves}</p></div>
                            <div class="col-6"><small class="text-muted">Color</small><p class="mb-1">${r.leaf_color}</p></div>
                            <div class="col-6"><small class="text-muted">Officer</small><p class="mb-1">${r.agent_name}</p></div>
                        </div>
                    `;
                    $('#recordDetails').html(html);
                    $('#editFromViewBtn, #deleteFromViewBtn').data('id', r.id);
                    $('#viewModal').modal('show');
                }
            }
        });
    });
    
    // Edit record
    $(document).on('click', '.edit-record', function() {
        const recordId = $(this).data('id');
        
        $.ajax({
            url: `${urls.detail}${recordId}/`,
            type: 'GET',
            success: function(response) {
                if (response?.success) {
                    const r = response.data;
                    resetForm();
                    loadQRCodes();
                    loadDistricts();
                    loadProjectOfficers();
                    
                    $('#recordId').val(r.id);
                    $('#plant_uid').val(r.plant_uid);
                    $('#number_of_leaves').val(r.number_of_leaves);
                    $('#height').val(r.height);
                    $('#stem_size').val(r.stem_size);
                    $('#leaf_color').val(r.leaf_color);
                    $('#date').val(r.date);
                    $('#lat').val(r.lat);
                    $('#lng').val(r.lng);
                    
                    setTimeout(() => {
                        $('#agent_id').val(r.agent_id);
                        $('#district_id').val(r.district_id);
                        $('#qr_code').val(r.qr_code_id);
                        if (r.lat && r.lng) initMap(r.lat, r.lng);
                    }, 200);
                    
                    $('#recordModal').modal('show');
                }
            }
        });
    });
    
    // Growth History Button Handler
    $(document).on('click', '.growth-history', function() {
        const plantUid = $(this).data('plant');
        
        // Reset state
        currentChartData = null;
        isProgressChartInitialized = false;
        isModalLoaded = false;
        
        // Show modal and loading state
        $('#growthHistoryModal').modal('show');
        $('#growthHistoryLoading').show();
        $('#growthHistoryContent').hide();
        
        // Destroy existing charts
        destroyCharts();
        
        // Clear all canvases
        clearCanvas('heightHistoryChart');
        clearCanvas('leavesHistoryChart');
        clearCanvas('stemHistoryChart');
        clearCanvas('healthHistoryChart');
        clearCanvas('growthProgressChart');
        
        // Load plant growth history
        $.ajax({
            url: `/api/growth-monitoring/plant-history/${encodeURIComponent(plantUid)}/`,
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    displayGrowthHistory(response.data);
                    $('#growthHistoryLoading').hide();
                    $('#growthHistoryContent').show();
                    isModalLoaded = true;
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: response.error || 'Failed to load growth history'
                    });
                    $('#growthHistoryModal').modal('hide');
                }
            },
            error: function(xhr) {
                console.error('Error loading growth history:', xhr);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load growth history data'
                });
                $('#growthHistoryModal').modal('hide');
            }
        });
    });
    
    // Print Growth History Report
    $('#printGrowthHistory').click(function() {
        const plantUid = $('#plantUidDisplay').text();
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <html>
                <head>
                    <title>Growth History - ${plantUid}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; }
                        .print-header { margin-bottom: 30px; }
                        .stat-card { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
                        .badge { padding: 5px 10px; }
                        @media print {
                            .no-print { display: none; }
                            .page-break { page-break-after: always; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h2>Plant Growth History Report</h2>
                        <h5>Plant UID: ${plantUid}</h5>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div id="printContent">
                        ${$('#growthHistoryContent').html()}
                    </div>
                    <script>
                        window.onload = function() { window.print(); window.close(); }
                    <\/script>
                </body>
            </html>
        `);
        
        printWindow.document.close();
    });
    
    // Delete record
    $(document).on('click', '.delete-record, #deleteFromViewBtn', function() {
        currentRecordId = $(this).data('id');
        $('#deleteModal').modal('show');
    });
    
    $('#confirmDeleteBtn').click(function() {
        if (!currentRecordId) return;
        
        $.ajax({
            url: `${urls.delete}${currentRecordId}/delete/`,
            type: 'DELETE',
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            beforeSend: () => $('#confirmDeleteBtn').prop('disabled', true).html('<span class="loading-spinner"></span>'),
            success: function(response) {
                if (response?.success) {
                    Swal.fire({icon: 'success', title: 'Deleted', timer: 1500, showConfirmButton: false});
                    $('#deleteModal').modal('hide');
                    growthTable.ajax.reload(null, false);
                    loadStats();
                }
            },
            complete: () => {
                $('#confirmDeleteBtn').prop('disabled', false).html('Delete');
                currentRecordId = null;
            }
        });
    });
    
    // Map update
    $('#lat, #lng').on('change', function() {
        const lat = parseFloat($('#lat').val());
        const lng = parseFloat($('#lng').val());
        if (!isNaN(lat) && !isNaN(lng)) initMap(lat, lng);
    });
    
    // Filter handlers
    $('#applyFilters').click(() => growthTable.ajax.reload());
    $('#resetFilters').click(function() {
        $('#startDate, #endDate, #filterDistrict, #filterAgent').val('');
        growthTable.ajax.reload();
    });
    
    // Edit from view
    $('#editFromViewBtn').click(function() {
        const recordId = $(this).data('id');
        $('#viewModal').modal('hide');
        setTimeout(() => $(`.edit-record[data-id="${recordId}"]`).click(), 300);
    });
    
    // Clean up chart instances when modal is hidden
    $('#growthHistoryModal').on('hidden.bs.modal', function() {
        destroyCharts();
        currentChartData = null;
        isProgressChartInitialized = false;
        isModalLoaded = false;
    });
    
    // CSRF helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            document.cookie.split(';').some(c => {
                const match = c.trim().match(new RegExp(`^${name}=(.+)$`));
                if (match) cookieValue = decodeURIComponent(match[1]);
                return match;
            });
        }
        return cookieValue;
    }
    
    // ============ BIND CHART TABS EVENT ONLY ONCE ============
    function bindChartTabsEvent() {
        if (!chartTabsBound) {
            $('#chartTabs .nav-link').on('shown.bs.tab', function(e) {
                if (currentChartData && isModalLoaded) {
                    const activeTab = $(e.target).attr('id');
                    
                    if (activeTab === 'height-tab') {
                        if (heightChart) {
                            heightChart.destroy();
                            heightChart = null;
                        }
                        initHeightChart();
                    } else if (activeTab === 'leaves-tab') {
                        if (leavesChart) {
                            leavesChart.destroy();
                            leavesChart = null;
                        }
                        initLeavesChart();
                    } else if (activeTab === 'stem-tab') {
                        if (stemChart) {
                            stemChart.destroy();
                            stemChart = null;
                        }
                        initStemChart();
                    } else if (activeTab === 'health-tab') {
                        if (healthChart) {
                            healthChart.destroy();
                            healthChart = null;
                        }
                        initHealthChart();
                    }
                }
            });
            chartTabsBound = true;
        }
    }
    
    // Initialize
    loadStats();
    loadDistricts();
    loadProjectOfficers();
    bindChartTabsEvent(); // Bind tab events once at initialization
});
</script>

{% endblock %}