{% extends 'web_base.html' %}
{% load static %}

{% block content %}

<br>
<!-- Page Header -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <h4 class="mb-0">Activities Overview</h4>
            <div class="page-title-right">
                <button class="btn btn-primary" id="addActivityBtn">
                    <i class="fas fa-plus me-1"></i> Add New Activity
                </button>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Stats Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-40">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Activities</span>
                        <h4 class="mb-3" id="totalActivities">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-tasks text-primary h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-40">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Completed</span>
                        <h4 class="mb-3" id="completedActivities">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-success h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-40">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Pending</span>
                        <h4 class="mb-3" id="pendingActivities">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-warning h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-40">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Area Covered</span>
                        <h4 class="mb-3" id="totalArea">0 ha</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-map-marked-alt text-info h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Main Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="activitiesTable" class="table table-striped datatable" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Reporting Date</th>
                                <th>Agent</th>
                                <th>Main Activity</th>
                                <th>Sub Activity</th>
                                <th>Farm Ref</th>
                                <th>Area (ha)</th>
                                <th># of RAs</th>
                                <th>Status</th>
                                <th>District</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Activity Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header  text-white">
                <h5 class="modal-title" id="modalTitle">Add New Activity</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="activityForm" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="activityId" name="activity_id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reporting_date" class="form-label">Reporting Date *</label>
                                <input type="date" class="form-control" id="reporting_date" name="reporting_date" required>
                                <div class="invalid-feedback">Please select reporting date</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="completion_date" class="form-label">Completion Date</label>
                                <input type="date" class="form-control" id="completion_date" name="completion_date">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="agent" class="form-label">Project Officer *</label>
                                <select class="form-select" id="agent" name="agent_id" required>
                                    <option value="">Select PO</option>
                                </select>
                                <div class="invalid-feedback">Please select Project Officer</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="district" class="form-label">District</label>
                                <input type="text" class="form-control" id="district" name="district" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="main_activity" class="form-label">Main Activity *</label>
                                <select class="form-select" id="main_activity" name="main_activity_id" required>
                                    <option value="">Select Main Activity</option>
                                </select>
                                <div class="invalid-feedback">Please select main activity</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sub_activity" class="form-label">Sub Activity *</label>
                                <select class="form-select" id="sub_activity" name="sub_activity_id" required>
                                    <option value="">Select Sub Activity</option>
                                </select>
                                <div class="invalid-feedback">Please select sub activity</div>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="farm_ref_number" class="form-label">Farm Reference</label>
                                <input type="text" class="form-control" id="farm_ref_number" name="farm_ref_number">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="farm_size_ha" class="form-label">Farm Size (ha)</label>
                                <input type="number" class="form-control" id="farm_size_ha" name="farm_size_ha" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="sector" class="form-label">Sector</label>
                                <input type="number" class="form-control" id="sector" name="sector" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="area_covered_ha" class="form-label">Area Covered (ha) *</label>
                                <input type="number" class="form-control" id="area_covered_ha" name="area_covered_ha" step="0.01" min="0" required>
                                <div class="invalid-feedback">Please enter area covered</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="no_rehab_assistants" class="form-label">Number of RAs</label>
                                <input type="number" class="form-control" id="no_rehab_assistants" name="no_rehab_assistants" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="group_work" class="form-label">Group Work</label>
                                <select class="form-select" id="group_work" name="group_work">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="number_of_people_in_group" class="form-label">People in Group</label>
                                <input type="number" class="form-control" id="number_of_people_in_group" name="number_of_people_in_group" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="0">Pending</option>
                                    <option value="1">Submitted</option>
                                    <option value="2">Approved</option>
                                    <option value="3">Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-group">
                                <label for="remark" class="form-label">Remarks</label>
                                <textarea class="form-control" id="remark" name="remark" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Activity</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this activity report?</p>
                <div class="form-group">
                    <label for="deleteReason" class="form-label">Reason for deletion:</label>
                    <textarea class="form-control" id="deleteReason" rows="3" placeholder="Enter reason for deletion..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- View Activity Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header  text-white">
                <h5 class="modal-title">Activity Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activityDetails">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printActivityBtn">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Required CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css">

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    
    // Define URLs for AJAX calls
    var urls = {
        activityList: "{% url 'activity_list_api' %}",
        activityCreate: "{% url 'activity_create' %}",
        activityDetail: "{% url 'activity_detail' 0 %}",
        activityUpdate: "{% url 'activity_update' 0 %}",
        activityDelete: "{% url 'activity_delete' 0 %}",
        getAgents: "{% url 'get_agents' %}",
        getMainActivities: "{% url 'get_main_activities' %}",
        getSubActivities: "{% url 'get_sub_activities' %}"
    };
    
    // Initialize DataTable
    var activitiesTable = $('#activitiesTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: urls.activityList,
            type: "GET"
        },
        columns: [
            { data: 'id' },
            { 
                data: 'reporting_date',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'agent_name',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'main_activity',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { 
                data: 'sub_activity',
                render: function(data) {
                    return data || 'N/A';
                }
            },
            { data: 'farm_ref_number' },
            { 
                data: 'area_covered_ha',
                render: function(data) {
                    return data ? parseFloat(data).toFixed(2) + ' ha' : '0.00 ha';
                }
            },
            { data: 'no_rehab_assistants' },
            { 
                data: 'status',
                render: function(data) {
                    var badgeClass = 'bg-';
                    var statusText = '';
                    switch(parseInt(data)) {
                        case 0: 
                            badgeClass += 'warning'; 
                            statusText = 'Pending';
                            break;
                        case 1: 
                            badgeClass += 'success'; 
                            statusText = 'Submitted';
                            break;
                        case 2: 
                            badgeClass += 'info'; 
                            statusText = 'Approved';
                            break;
                        case 3: 
                            badgeClass += 'danger'; 
                            statusText = 'Rejected';
                            break;
                        default: 
                            badgeClass += 'secondary';
                            statusText = 'Unknown';
                    }
                    return '<span class="badge ' + badgeClass + '">' + statusText + '</span>';
                }
            },
            { data: 'district' },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info view-activity" data-id="${data}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary edit-activity" data-id="${data}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger delete-activity" data-id="${data}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                },
                orderable: false,
                searchable: false
            }
        ],
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            },
        ],
        order: [[1, 'desc']],
        language: {
            emptyTable: "No activities found",
            zeroRecords: "No matching activities found"
        },
        dom: 'Bfrtip'
    });

    // Load dropdown data
    function loadDropdowns() {
        // Load agents
        $.ajax({
            url: urls.getAgents,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $agentSelect = $('#agent');
                    $agentSelect.empty().append('<option value="">Select PO</option>');
                    response.data.forEach(function(agent) {
                        $agentSelect.append(`<option value="${agent.id}">${agent.name} (${agent.staffid || 'N/A'})</option>`);
                    });
                }
            },
            error: function(xhr) {
                console.error('Failed to load agents:', xhr);
            }
        });

        // Load main activities
        $.ajax({
            url: urls.getMainActivities,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $mainActivitySelect = $('#main_activity');
                    $mainActivitySelect.empty().append('<option value="">Select Main Activity</option>');
                    response.data.forEach(function(activity) {
                        $mainActivitySelect.append(`<option value="${activity.id}">${activity.main_activity}</option>`);
                    });
                }
            },
            error: function(xhr) {
                console.error('Failed to load main ', xhr);
            }
        });
    }

    // Load sub activities based on main activity
    $('#main_activity').on('change', function() {
        var mainActivityId = $(this).val();
        var $subActivitySelect = $('#sub_activity');
        
        $subActivitySelect.empty().append('<option value="">Select Sub Activity</option>');
        
        if (mainActivityId) {
            $.ajax({
                url: urls.getSubActivities,
                type: "GET",
                data: { main_activity_id: mainActivityId },
                success: function(response) {
                    if (response.success) {
                        response.data.forEach(function(activity) {
                            $subActivitySelect.append(`<option value="${activity.id}">${activity.sub_activity} (${activity.activity_code || 'N/A'})</option>`);
                        });
                    }
                },
                error: function(xhr) {
                    console.error('Failed to load sub ', xhr);
                }
            });
        }
    });

    // Load stats
    function loadStats() {
        $.ajax({
            url: urls.activityList,
            type: "GET",
            data: { draw: 1, start: 0, length: 1000 },
            success: function(response) {
                var data = response.data || [];
                var total = data.length;
                var completed = data.filter(a => a.status === 1 || a.status === 2).length;
                var pending = data.filter(a => a.status === 0).length;
                var totalArea = data.reduce((sum, a) => sum + (parseFloat(a.area_covered_ha) || 0), 0);
                
                $('#totalActivities').text(total);
                $('#completedActivities').text(completed);
                $('#pendingActivities').text(pending);
                $('#totalArea').text(totalArea.toFixed(2) + ' ha');
            },
            error: function(xhr) {
                console.error('Failed to load stats:', xhr);
            }
        });
    }

    // Add Activity Button
    $('#addActivityBtn').click(function() {
        $('#activityForm')[0].reset();
        $('#modalTitle').text('Add New Activity');
        $('#activityId').val('');
        $('#district').val('').prop('readonly', true);
        loadDropdowns();
        $('#activityModal').modal('show');
    });

    // Form Submission
    $('#activityForm').submit(function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            e.stopPropagation();
            $(this).addClass('was-validated');
            return;
        }
        
        var formData = {
            reporting_date: $('#reporting_date').val(),
            completion_date: $('#completion_date').val(),
            agent_id: $('#agent').val(),
            main_activity_id: $('#main_activity').val(),
            sub_activity_id: $('#sub_activity').val(),
            no_rehab_assistants: $('#no_rehab_assistants').val() || 0,
            area_covered_ha: $('#area_covered_ha').val() || 0,
            farm_ref_number: $('#farm_ref_number').val(),
            farm_size_ha: $('#farm_size_ha').val() || 0,
            sector: $('#sector').val(),
            group_work: $('#group_work').val(),
            number_of_people_in_group: $('#number_of_people_in_group').val() || 0,
            remark: $('#remark').val(),
            status: $('#status').val() || 0
        };
        
        var activityId = $('#activityId').val();
        var url = activityId ? 
            urls.activityUpdate.replace('0', activityId) : 
            urls.activityCreate;
        
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#activityModal').modal('hide');
                    activitiesTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html('Save Activity');
            }
        });
    });

    // Edit Activity
    $(document).on('click', '.edit-activity', function() {
        var activityId = $(this).data('id');
        
        $.ajax({
            url: urls.activityDetail.replace('0', activityId),
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    var activity = response.data;
                    
                    $('#activityId').val(activity.id);
                    $('#reporting_date').val(activity.reporting_date);
                    $('#completion_date').val(activity.completion_date);
                    $('#farm_ref_number').val(activity.farm_ref_number);
                    $('#farm_size_ha').val(activity.farm_size_ha);
                    $('#area_covered_ha').val(activity.area_covered_ha);
                    $('#no_rehab_assistants').val(activity.no_rehab_assistants);
                    $('#sector').val(activity.sector);
                    $('#group_work').val(activity.group_work);
                    $('#number_of_people_in_group').val(activity.number_of_people_in_group);
                    $('#remark').val(activity.remark);
                    $('#status').val(activity.status);
                    $('#district').val(activity.district);
                    
                    // Load dropdowns first, then set values
                    loadDropdowns();
                    
                    // Set values after a short delay to ensure dropdowns are loaded
                    setTimeout(function() {
                        $('#agent').val(activity.agent_id);
                        $('#main_activity').val(activity.main_activity_id).trigger('change');
                        
                        setTimeout(function() {
                            $('#sub_activity').val(activity.sub_activity_id);
                        }, 500);
                    }, 500);
                    
                    $('#modalTitle').text('Edit Activity');
                    $('#activityModal').modal('show');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Failed to load activity details', 'error');
            }
        });
    });

    // View Activity
    $(document).on('click', '.view-activity', function() {
        var activityId = $(this).data('id');
        
        $.ajax({
            url: urls.activityDetail.replace('0', activityId),
            type: 'GET',
            beforeSend: function() {
                $('#activityDetails').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading activity details...</p>
                    </div>
                `);
            },
            success: function(response) {
                if (response.success) {
                    var activity = response.data;
                    var statusText = '';
                    var statusClass = '';
                    
                    switch(parseInt(activity.status)) {
                        case 0: statusText = 'Pending'; statusClass = 'warning'; break;
                        case 1: statusText = 'Submitted'; statusClass = 'success'; break;
                        case 2: statusText = 'Approved'; statusClass = 'info'; break;
                        case 3: statusText = 'Rejected'; statusClass = 'danger'; break;
                        default: statusText = 'Unknown'; statusClass = 'secondary';
                    }
                    
                    var html = `
                        <div class="activity-details">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Activity ID</h6>
                                    <p class="fw-bold">${activity.id}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Status</h6>
                                    <p><span class="badge bg-${statusClass}">${statusText}</span></p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Reporting Date</h6>
                                    <p class="fw-bold">${activity.reporting_date || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Completion Date</h6>
                                    <p class="fw-bold">${activity.completion_date || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Project Officer</h6>
                                    <p class="fw-bold">${activity.agent_name}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">District</h6>
                                    <p class="fw-bold">${activity.district || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="text-muted">Main Activity</h6>
                                    <p class="fw-bold">${activity.main_activity}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="text-muted">Sub Activity</h6>
                                    <p class="fw-bold">${activity.sub_activity}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <h6 class="text-muted">Farm Reference</h6>
                                    <p class="fw-bold">${activity.farm_ref_number || 'N/A'}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted">Farm Size</h6>
                                    <p class="fw-bold">${activity.farm_size_ha ? parseFloat(activity.farm_size_ha).toFixed(2) + ' ha' : 'N/A'}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted">Area Covered</h6>
                                    <p class="fw-bold">${activity.area_covered_ha ? parseFloat(activity.area_covered_ha).toFixed(2) + ' ha' : '0.00 ha'}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <h6 class="text-muted"># of RAs</h6>
                                    <p class="fw-bold">${activity.no_rehab_assistants || 0}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted">Group Work</h6>
                                    <p class="fw-bold">${activity.group_work || 'No'}</p>
                                </div>
                                <div class="col-md-4">
                                    <h6 class="text-muted">People in Group</h6>
                                    <p class="fw-bold">${activity.number_of_people_in_group || 0}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-muted">Remarks</h6>
                                    <p class="fw-bold">${activity.remark || 'No remarks'}</p>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-muted">Created Date</h6>
                                    <p class="fw-bold">${activity.created_date || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#activityDetails').html(html);
                    $('#viewModal').modal('show');
                } else {
                    $('#activityDetails').html(`
                        <div class="alert alert-danger">
                            Failed to load activity details: ${response.message}
                        </div>
                    `);
                }
            },
            error: function() {
                $('#activityDetails').html(`
                    <div class="alert alert-danger">
                        Failed to load activity details
                    </div>
                `);
            }
        });
    });

    // Delete Activity
    var deleteActivityId = null;
    $(document).on('click', '.delete-activity', function() {
        deleteActivityId = $(this).data('id');
        $('#deleteReason').val('');
        $('#deleteModal').modal('show');
    });

    $('#confirmDeleteBtn').click(function() {
        var reason = $('#deleteReason').val();
        if (!reason.trim()) {
            Swal.fire('Error', 'Please provide a reason for deletion', 'error');
            return;
        }
        
        $.ajax({
            url: urls.activityDelete.replace('0', deleteActivityId),
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ reason: reason }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#deleteModal').modal('hide');
                    activitiesTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#confirmDeleteBtn').prop('disabled', false).html('Delete');
            }
        });
    });

    // Print Activity Details
    $('#printActivityBtn').click(function() {
        var printContent = $('#activityDetails').html();
        var originalContent = $('body').html();
        
        $('body').html(`
            <div class="container mt-5">
                <h2 class="text-center mb-4">Activity Report</h2>
                ${printContent}
                <div class="mt-5 text-center">
                    <small>Printed on: ${new Date().toLocaleString()}</small>
                </div>
            </div>
        `);
        
        window.print();
        $('body').html(originalContent);
        $('#viewModal').modal('show');
    });

    // CSRF Token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initial load
    loadStats();
});
</script>

<style>
.card-h-30 {
    height: 30%;
}

.activity-details h6 {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.3rem;
}

.activity-details p {
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

@media print {
    .modal-header, .modal-footer, .btn {
        display: none !important;
    }
    
    .modal-dialog {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    .modal-content {
        border: none !important;
        box-shadow: none !important;
    }
    
    .modal-body {
        padding: 0 !important;
    }
}
</style>
{% endblock %}