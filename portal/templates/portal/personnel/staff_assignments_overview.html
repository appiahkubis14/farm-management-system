{% extends 'web_base.html' %}
{% load static %}

{% block content %}
<br>
<!-- Page Header -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <h4 class="mb-0">Staff Assignments Management</h4>
            <div class="page-title-right">
                <button class="btn btn-primary" id="addAssignmentBtn">
                    <i class="fas fa-plus me-1"></i> New Assignment
                </button>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Stats Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Assignments</span>
                        <h4 class="mb-3" id="totalAssignments">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-tasks text-primary h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Active Assignments</span>
                        <h4 class="mb-3" id="activeAssignments">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-success h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Pending Approval</span>
                        <h4 class="mb-3" id="pendingAssignments">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-clock text-warning h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">RAs Assigned</span>
                        <h4 class="mb-3" id="rasAssigned">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-friends text-info h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Filters Row -->
<!-- <div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterStatus" class="form-label">Status</label>
                        <select class="form-select" id="filterStatus">
                            <option value="">All Statuses</option>
                            {% for status in assignment_status %}
                                <option value="{{ status.value }}">{{ status.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterPO" class="form-label">Project Officer</label>
                        <select class="form-select" id="filterPO">
                            <option value="">All POs</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterDistrict" class="form-label">District</label>
                        <select class="form-select" id="filterDistrict">
                            <option value="">All Districts</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-secondary me-2" id="clearFiltersBtn">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button class="btn btn-primary" id="applyFiltersBtn">
                            <i class="fas fa-filter"></i> Apply
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!-- Main Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="assignmentsTable" class="table table-striped datatable" style="width:100%">
                        <thead>
                            <tr>
                                <th>Assignment ID</th>
                                <th>Rehab Assistant</th>
                                <th>Project Officer</th>
                                <th>District</th>
                                <th>Community</th>
                                <th>Date Assigned</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Assignment Modal -->
<div class="modal fade" id="assignmentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Create New Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="assignmentForm" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="assignmentId" name="assignment_id">
                    <input type="hidden" id="uid" name="uid">
                    
                    <!-- Assignment Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user-tag me-2"></i>Assignment Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ra_id" class="form-label">Rehab Assistant *</label>
                                    <select class="form-select" id="ra_id" name="ra_id" required>
                                        <option value="">Select Rehab Assistant</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a Rehab Assistant</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="po_id" class="form-label">Project Officer *</label>
                                    <select class="form-select" id="po_id" name="po_id" required>
                                        <option value="">Select Project Officer</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a Project Officer</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="assignment_district_id" class="form-label">District *</label>
                                    <select class="form-select" id="assignment_district_id" name="district_id" required>
                                        <option value="">Select District</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a district</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="assignment_community_id" class="form-label">Community</label>
                                    <select class="form-select" id="assignment_community_id" name="community_id">
                                        <option value="">Select Community</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="assignment_project_id" class="form-label">Project</label>
                                    <select class="form-select" id="assignment_project_id" name="project_id">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="date_assigned" class="form-label">Date Assigned *</label>
                                    <input type="date" class="form-control" id="date_assigned" name="date_assigned" required>
                                    <div class="invalid-feedback">Please enter assignment date</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RA Information Preview -->
                    <div class="card mb-3" id="raPreviewCard" style="display: none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Rehab Assistant Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row" id="raPreviewContent">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- PO Information Preview -->
                    <div class="card mb-3" id="poPreviewCard" style="display: none;">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Project Officer Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row" id="poPreviewContent">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Create Assignment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Assignment Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Assignment Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="assignmentDetails">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printAssignmentBtn">
                    <i class="fas fa-print me-1"></i> Print
                </button>
                <button type="button" class="btn btn-warning" id="editFromViewBtn">
                    <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button type="button" class="btn btn-success" id="submitFromViewBtn">
                    <i class="fas fa-check-circle me-1"></i> Submit
                </button>
                <button type="button" class="btn btn-dark" id="revokeFromViewBtn">
                    <i class="fas fa-ban me-1"></i> Revoke
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade" id="submitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Submit Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit this assignment for approval?</p>
                <p class="mb-0 text-muted"><small>Once submitted, the assignment will be reviewed by the administrator.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmSubmitBtn">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Revoke Confirmation Modal -->
<div class="modal fade" id="revokeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Revoke Assignment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to revoke this assignment?</p>
                <div class="form-group">
                    <label for="revokeReason" class="form-label">Reason for revocation:</label>
                    <textarea class="form-control" id="revokeReason" rows="3" placeholder="Enter reason for revocation..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-dark" id="confirmRevokeBtn">Revoke</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this assignment? This action cannot be undone.</p>
                <div class="form-group">
                    <label for="deleteReason" class="form-label">Reason for deletion:</label>
                    <textarea class="form-control" id="deleteReason" rows="3" placeholder="Enter reason for deletion..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Required CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css">

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    
    // Initialize DataTable
    var assignmentsTable = $('#assignmentsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "{% url 'assignments_list_api' %}",
            type: "GET",
            data: function(d) {
                d.status = $('#filterStatus').val();
                d.po_id = $('#filterPO').val();
                d.district_id = $('#filterDistrict').val();
            }
        },
        columns: [
            { 
                data: 'assignment_code',
                render: function(data, type, row) {
                    return `<a href="#" class="view-assignment-link" data-id="${row.id}">${data}</a>`;
                }
            },
            { 
                data: null,
                render: function(data) {
                    return `<strong>${data.ra_name}</strong><br>
                            <small class="text-muted">${data.ra_staff_id}</small>`;
                }
            },
            { 
                data: null,
                render: function(data) {
                    return `<strong>${data.po_name}</strong><br>
                            <small class="text-muted">${data.po_staff_id}</small>`;
                }
            },
            { data: 'district' },
            { data: 'community' },
            { 
                data: 'date_assigned',
                render: function(data) {
                    if (data) {
                        var date = new Date(data);
                        return date.toLocaleDateString();
                    }
                    return '<span class="text-muted">N/A</span>';
                }
            },
            { 
                data: null,
                render: function(data) {
                    return `<span class="badge ${data.status_badge}">${data.status_text}</span>`;
                }
            },
            {
                data: 'id',
                render: function(data, type, row) {
                    var buttons = `
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info view-assignment" data-id="${data}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary edit-assignment" data-id="${data}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>`;
                    
                    if (row.status === 0) {
                        buttons += `<button class="btn btn-success submit-assignment" data-id="${data}" title="Submit">
                                        <i class="fas fa-check-circle"></i>
                                    </button>`;
                    }
                    
                    if (row.status === 0 || row.status === 1 || row.status === 2) {
                        buttons += `<button class="btn btn-dark revoke-assignment" data-id="${data}" title="Revoke">
                                        <i class="fas fa-ban"></i>
                                    </button>`;
                    }
                    
                    buttons += `<button class="btn btn-danger delete-assignment" data-id="${data}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    
                    return buttons;
                },
                orderable: false,
                searchable: false
            }
        ],
        responsive: true,
        order: [[5, 'desc']],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            },
            {
                extend: "print",
                text: '<i class="fas fa-print"></i> Print',
                className: "btn btn-sm btn-outline-info",
            }
        ],
        language: {
            emptyTable: "No assignments found",
            zeroRecords: "No matching assignments found"
        }
    });

    // Load stats
    function loadStats() {
        $.ajax({
            url: "{% url 'assignments_list_api' %}",
            type: "GET",
            data: { draw: 1, start: 0, length: 1000 },
            success: function(response) {
                var data = response.data || [];
                var total = data.length;
                var active = data.filter(a => a.status === 1 || a.status === 2).length;
                var pending = data.filter(a => a.status === 0).length;
                
                // Get unique RAs
                var uniqueRas = new Set(data.map(a => a.ra_id).filter(id => id));
                
                $('#totalAssignments').text(total);
                $('#activeAssignments').text(active);
                $('#pendingAssignments').text(pending);
                $('#rasAssigned').text(uniqueRas.size);
            },
            error: function() {
                $('#totalAssignments').text('0');
                $('#activeAssignments').text('0');
                $('#pendingAssignments').text('0');
                $('#rasAssigned').text('0');
            }
        });
    }

    // Load POs for dropdown
    function loadPOs(selectedId = null) {
        $.ajax({
            url: "{% url 'po_list' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $poSelect = $('#po_id');
                    var $filterPO = $('#filterPO');
                    
                    $poSelect.empty().append('<option value="">Select Project Officer</option>');
                    $filterPO.empty().append('<option value="">All POs</option>');
                    
                    response.data.forEach(function(po) {
                        var selected = (selectedId && po.id == selectedId) ? 'selected' : '';
                        $poSelect.append(`<option value="${po.id}" ${selected}>${po.name} (${po.staff_id})</option>`);
                        $filterPO.append(`<option value="${po.id}">${po.name} (${po.staff_id})</option>`);
                    });
                    
                    // Initialize Select2
                    $poSelect.select2({
                        placeholder: "Search for Project Officer...",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignmentModal')
                    });
                    
                    $filterPO.select2({
                        placeholder: "Filter by PO",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('.modal:visible').length ? $('.modal:visible') : 'body'
                    });
                }
            }
        });
    }

    // Load RAs for dropdown
    function loadRAs(selectedId = null) {
        $.ajax({
            url: "{% url 'ra_list' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $raSelect = $('#ra_id');
                    
                    $raSelect.empty().append('<option value="">Select Rehab Assistant</option>');
                    
                    response.data.forEach(function(ra) {
                        var selected = (selectedId && ra.id == selectedId) ? 'selected' : '';
                        $raSelect.append(`<option value="${ra.id}" ${selected}>${ra.name} (${ra.staff_id}) - ${ra.district}</option>`);
                    });
                    
                    // Initialize Select2
                    $raSelect.select2({
                        placeholder: "Search for Rehab Assistant...",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignmentModal')
                    });
                }
            }
        });
    }

    // Load districts for dropdown
    function loadDistricts(selectedId = null) {
        $.ajax({
            url: "{% url 'get_districts' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $districtSelect = $('#assignment_district_id');
                    var $filterDistrict = $('#filterDistrict');
                    
                    $districtSelect.empty().append('<option value="">Select District</option>');
                    $filterDistrict.empty().append('<option value="">All Districts</option>');
                    
                    response.data.forEach(function(district) {
                        var selected = (selectedId && district.id == selectedId) ? 'selected' : '';
                        $districtSelect.append(`<option value="${district.id}" ${selected}>${district.name}</option>`);
                        $filterDistrict.append(`<option value="${district.id}">${district.name}</option>`);
                    });
                    
                    // Initialize Select2
                    $districtSelect.select2({
                        placeholder: "Select District",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignmentModal')
                    });
                    
                    $filterDistrict.select2({
                        placeholder: "Filter by District",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('.modal:visible').length ? $('.modal:visible') : 'body'
                    });
                }
            }
        });
    }

    // Load communities by district
    function loadCommunities(districtId, selectedId = null) {
        if (!districtId) {
            $('#assignment_community_id').empty().append('<option value="">Select Community</option>');
            return;
        }
        
        $.ajax({
            url: "{% url 'get_communities' %}",
            type: "GET",
            data: { district_id: districtId },
            success: function(response) {
                if (response.success) {
                    var $communitySelect = $('#assignment_community_id');
                    $communitySelect.empty().append('<option value="">Select Community</option>');
                    
                    response.data.forEach(function(community) {
                        var selected = (selectedId && community.id == selectedId) ? 'selected' : '';
                        $communitySelect.append(`<option value="${community.id}" ${selected}>${community.name}</option>`);
                    });
                    
                    // Initialize Select2
                    $communitySelect.select2({
                        placeholder: "Select Community",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignmentModal')
                    });
                }
            }
        });
    }

    // Load projects for dropdown
    function loadProjects(selectedId = null) {
        $.ajax({
            url: "{% url 'get_projects' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $projectSelect = $('#assignment_project_id');
                    
                    $projectSelect.empty().append('<option value="">Select Project</option>');
                    
                    response.data.forEach(function(project) {
                        var selected = (selectedId && project.id == selectedId) ? 'selected' : '';
                        $projectSelect.append(`<option value="${project.id}" ${selected}>${project.name}</option>`);
                    });
                    
                    // Initialize Select2
                    $projectSelect.select2({
                        placeholder: "Select Project",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: $('#assignmentModal')
                    });
                }
            }
        });
    }

    // RA selection change - show preview
    $('#ra_id').on('change', function() {
        var raId = $(this).val();
        
        if (raId) {
            $.ajax({
                url: "{% url 'staff_detail_api' 0 %}".replace('0', raId),
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var ra = response.data;
                        var html = `
                            <div class="col-md-6">
                                <strong>Name:</strong> ${ra.full_name}<br>
                                <strong>Staff ID:</strong> ${ra.staff_id}<br>
                                <strong>Phone:</strong> ${ra.primary_phone_number}
                            </div>
                            <div class="col-md-6">
                                <strong>District:</strong> ${ra.district}<br>
                                <strong>Community:</strong> ${ra.community}<br>
                                <strong>Date Joined:</strong> ${ra.date_joined}
                            </div>
                        `;
                        $('#raPreviewContent').html(html);
                        $('#raPreviewCard').show();
                    }
                },
                error: function() {
                    $('#raPreviewCard').hide();
                }
            });
        } else {
            $('#raPreviewCard').hide();
        }
    });

    // PO selection change - show preview
    $('#po_id').on('change', function() {
        var poId = $(this).val();
        
        if (poId) {
            $.ajax({
                url: "{% url 'staff_detail_api' 0 %}".replace('0', poId),
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        var po = response.data;
                        var html = `
                            <div class="col-md-6">
                                <strong>Name:</strong> ${po.full_name}<br>
                                <strong>Staff ID:</strong> ${po.staff_id}<br>
                                <strong>Phone:</strong> ${po.primary_phone_number}
                            </div>
                            <div class="col-md-6">
                                <strong>District:</strong> ${po.district}<br>
                                <strong>Email:</strong> ${po.email || 'N/A'}<br>
                                <strong>Personnel Type:</strong> ${po.personnel_type}
                            </div>
                        `;
                        $('#poPreviewContent').html(html);
                        $('#poPreviewCard').show();
                    }
                },
                error: function() {
                    $('#poPreviewCard').hide();
                }
            });
        } else {
            $('#poPreviewCard').hide();
        }
    });

    // District change event
    $('#assignment_district_id').on('change', function() {
        var districtId = $(this).val();
        loadCommunities(districtId);
    });

    // Add Assignment Button
    $('#addAssignmentBtn').click(function() {
        $('#assignmentForm')[0].reset();
        $('#assignmentForm').removeClass('was-validated');
        $('#modalTitle').text('Create New Assignment');
        $('#assignmentId').val('');
        $('#uid').val('');
        $('#raPreviewCard').hide();
        $('#poPreviewCard').hide();
        
        // Clear Select2
        $('#ra_id').val(null).trigger('change');
        $('#po_id').val(null).trigger('change');
        $('#assignment_district_id').val(null).trigger('change');
        $('#assignment_community_id').val(null).trigger('change');
        $('#assignment_project_id').val(null).trigger('change');
        
        // Set default date
        $('#date_assigned').val(new Date().toISOString().split('T')[0]);
        
        loadRAs();
        loadPOs();
        loadDistricts();
        loadProjects();
        $('#assignmentModal').modal('show');
    });

    // Form Submission
    $('#assignmentForm').submit(function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            e.stopPropagation();
            $(this).addClass('was-validated');
            return;
        }
        
        var formData = {
            ra_id: $('#ra_id').val(),
            po_id: $('#po_id').val(),
            district_id: $('#assignment_district_id').val(),
            community_id: $('#assignment_community_id').val() || null,
            project_id: $('#assignment_project_id').val() || null,
            date_assigned: $('#date_assigned').val(),
            uid: $('#uid').val() || null
        };
        
        var assignmentId = $('#assignmentId').val();
        var url = assignmentId ? "{% url 'update_assignment' 0 %}".replace('0', assignmentId) : "{% url 'create_assignment' %}";
        
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#assignmentModal').modal('hide');
                    assignmentsTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html(assignmentId ? 'Update Assignment' : 'Create Assignment');
            }
        });
    });

    // Edit Assignment
    $(document).on('click', '.edit-assignment', function() {
        var assignmentId = $(this).data('id');
        
        $.ajax({
            url: "{% url 'assignment_detail_api' 0 %}".replace('0', assignmentId),
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    var assignment = response.data;
                    
                    // Load dropdowns first
                    loadRAs(assignment.ra.id);
                    loadPOs(assignment.po.id);
                    loadDistricts(assignment.district.id);
                    
                    setTimeout(function() {
                        if (assignment.district.id) {
                            loadCommunities(assignment.district.id, assignment.community.id);
                        }
                        loadProjects(assignment.project.id);
                        
                        // Populate form
                        $('#assignmentId').val(assignment.id);
                        $('#uid').val(assignment.uid);
                        $('#ra_id').val(assignment.ra.id).trigger('change');
                        $('#po_id').val(assignment.po.id).trigger('change');
                        $('#assignment_district_id').val(assignment.district.id).trigger('change');
                        $('#date_assigned').val(assignment.date_assigned);
                        
                        // Set community and project after delay
                        setTimeout(function() {
                            if (assignment.community.id) {
                                $('#assignment_community_id').val(assignment.community.id).trigger('change');
                            }
                            if (assignment.project.id) {
                                $('#assignment_project_id').val(assignment.project.id).trigger('change');
                            }
                        }, 500);
                    }, 500);
                    
                    $('#modalTitle').text('Edit Assignment');
                    $('#saveBtn').text('Update Assignment');
                    $('#assignmentModal').modal('show');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Failed to load assignment details', 'error');
            }
        });
    });

    // View Assignment
    $(document).on('click', '.view-assignment, .view-assignment-link', function(e) {
        if (e) e.preventDefault();
        var assignmentId = $(this).data('id');
        
        $.ajax({
            url: "{% url 'assignment_detail_api' 0 %}".replace('0', assignmentId),
            type: 'GET',
            beforeSend: function() {
                $('#assignmentDetails').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading assignment details...</p>
                    </div>
                `);
            },
            success: function(response) {
                if (response.success) {
                    var assignment = response.data;
                    
                    var html = `
                        <div class="assignment-details">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="border-bottom pb-2">Assignment Information</h5>
                                        <span class="badge ${assignment.status_badge} p-2">${assignment.status_text}</span>
                                    </div>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="30%">Assignment ID:</th>
                                            <td><strong>${assignment.assignment_code || ''}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Date Assigned:</th>
                                            <td>${assignment.date_assigned || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>District:</th>
                                            <td>${assignment.district.name} (${assignment.district.code || 'N/A'})</td>
                                        </tr>
                                        <tr>
                                            <th>Community:</th>
                                            <td>${assignment.community.name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Project:</th>
                                            <td>${assignment.project.name || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2">Rehab Assistant</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">Name:</th>
                                            <td><strong>${assignment.ra.name || 'N/A'}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Staff ID:</th>
                                            <td>${assignment.ra.staff_id || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Phone:</th>
                                            <td>${assignment.ra.phone || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Personnel Type:</th>
                                            <td>${assignment.ra.personnel_type || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Home District:</th>
                                            <td>${assignment.ra.district || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2">Project Officer</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">Name:</th>
                                            <td><strong>${assignment.po.name || 'N/A'}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Staff ID:</th>
                                            <td>${assignment.po.staff_id || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Phone:</th>
                                            <td>${assignment.po.phone || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2">System Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="20%">Created Date:</th>
                                            <td>${assignment.created_date || 'N/A'}</td>
                                            <th width="20%">Last Updated:</th>
                                            <td>${assignment.updated_date || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>UID:</th>
                                            <td colspan="3"><small>${assignment.uid || 'N/A'}</small></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    $('#assignmentDetails').html(html);
                    
                    // Store assignment ID for action buttons
                    $('#editFromViewBtn').data('id', assignment.id);
                    $('#submitFromViewBtn').data('id', assignment.id);
                    $('#revokeFromViewBtn').data('id', assignment.id);
                    
                    // Show/hide action buttons based on status
                    if (assignment.status === 0) {
                        $('#submitFromViewBtn').show();
                        $('#revokeFromViewBtn').show();
                    } else if (assignment.status === 1 || assignment.status === 2) {
                        $('#submitFromViewBtn').hide();
                        $('#revokeFromViewBtn').show();
                    } else {
                        $('#submitFromViewBtn').hide();
                        $('#revokeFromViewBtn').hide();
                    }
                    
                    $('#viewModal').modal('show');
                } else {
                    $('#assignmentDetails').html(`
                        <div class="alert alert-danger">
                            Failed to load assignment details: ${response.message}
                        </div>
                    `);
                }
            },
            error: function() {
                $('#assignmentDetails').html(`
                    <div class="alert alert-danger">
                        Failed to load assignment details
                    </div>
                `);
            }
        });
    });

    // Submit Assignment
    $(document).on('click', '.submit-assignment, #submitFromViewBtn', function() {
        var assignmentId = $(this).data('id');
        $('#submitModal').data('id', assignmentId).modal('show');
    });

    $('#confirmSubmitBtn').click(function() {
        var assignmentId = $('#submitModal').data('id');
        
        $.ajax({
            url: "{% url 'submit_assignment' 0 %}".replace('0', assignmentId),
            type: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#confirmSubmitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Submitting...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#submitModal').modal('hide');
                    $('#viewModal').modal('hide');
                    assignmentsTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#confirmSubmitBtn').prop('disabled', false).html('Submit');
            }
        });
    });

    // Revoke Assignment
    $(document).on('click', '.revoke-assignment, #revokeFromViewBtn', function() {
        var assignmentId = $(this).data('id');
        $('#revokeReason').val('');
        $('#revokeModal').data('id', assignmentId).modal('show');
    });

    $('#confirmRevokeBtn').click(function() {
        var assignmentId = $('#revokeModal').data('id');
        var reason = $('#revokeReason').val();
        
        if (!reason.trim()) {
            Swal.fire('Error', 'Please provide a reason for revocation', 'error');
            return;
        }
        
        $.ajax({
            url: "{% url 'revoke_assignment' 0 %}".replace('0', assignmentId),
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ reason: reason }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#confirmRevokeBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Revoking...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#revokeModal').modal('hide');
                    $('#viewModal').modal('hide');
                    assignmentsTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#confirmRevokeBtn').prop('disabled', false).html('Revoke');
            }
        });
    });

    // Edit from view modal
    $('#editFromViewBtn').click(function() {
        var assignmentId = $(this).data('id');
        $('#viewModal').modal('hide');
        
        setTimeout(function() {
            $(`.edit-assignment[data-id="${assignmentId}"]`).click();
        }, 500);
    });

    // Delete Assignment
    var deleteAssignmentId = null;
    $(document).on('click', '.delete-assignment', function() {
        deleteAssignmentId = $(this).data('id');
        $('#deleteReason').val('');
        $('#deleteModal').modal('show');
    });

    $('#confirmDeleteBtn').click(function() {
        var reason = $('#deleteReason').val();
        if (!reason.trim()) {
            Swal.fire('Error', 'Please provide a reason for deletion', 'error');
            return;
        }
        
        $.ajax({
            url: "{% url 'delete_assignment' 0 %}".replace('0', deleteAssignmentId),
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ reason: reason }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#deleteModal').modal('hide');
                    assignmentsTable.ajax.reload();
                    loadStats();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#confirmDeleteBtn').prop('disabled', false).html('Delete');
            }
        });
    });

    // Print Assignment Details
    $('#printAssignmentBtn').click(function() {
        var printContent = $('#assignmentDetails').html();
        var originalContent = $('body').html();
        
        $('body').html(`
            <div class="container mt-5">
                <h2 class="text-center mb-4">Staff Assignment Report</h2>
                <div class="text-center mb-4">
                    <h5>Assignment Details</h5>
                </div>
                ${printContent}
                <div class="mt-5 text-center">
                    <small>Printed on: ${new Date().toLocaleString()}</small>
                </div>
            </div>
        `);
        
        window.print();
        $('body').html(originalContent);
        
        // Re-initialize DataTable after print
        location.reload();
    });

    // Apply Filters
    $('#applyFiltersBtn').click(function() {
        assignmentsTable.ajax.reload();
    });

    // Clear Filters
    $('#clearFiltersBtn').click(function() {
        $('#filterStatus').val('');
        $('#filterPO').val(null).trigger('change');
        $('#filterDistrict').val(null).trigger('change');
        assignmentsTable.ajax.reload();
    });

    // CSRF Token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initial load
    loadStats();
    loadPOs();
    loadRAs();
    loadDistricts();
    loadProjects();
});
</script>

<style>
.card-h-30 {
    min-height: 120px;
}

.assignment-details h5 {
    color: #495057;
    font-size: 1rem;
    margin-bottom: 0.75rem;
}

.assignment-details table {
    margin-bottom: 0;
}

.assignment-details th {
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9rem;
}

.assignment-details td {
    font-size: 0.95rem;
}

.badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.view-assignment-link {
    color: #0d6efd;
    text-decoration: none;
    cursor: pointer;
}

.view-assignment-link:hover {
    text-decoration: underline;
}

.select2-container {
    width: 100% !important;
}

.select2-selection {
    min-height: 38px;
    border: 1px solid #ced4da !important;
}

.select2-selection__rendered {
    line-height: 38px !important;
}

.select2-selection__arrow {
    height: 38px !important;
}

#raPreviewCard, #poPreviewCard {
    border-left: 4px solid #0d6efd;
}

@media print {
    .modal-header, .modal-footer, .btn, .btn-group {
        display: none !important;
    }
    
    .modal-dialog {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    .modal-content {
        border: none !important;
        box-shadow: none !important;
    }
    
    .modal-body {
        padding: 0 !important;
    }
    
    .assignment-details {
        font-size: 12pt;
    }
}
</style>
{% endblock %}