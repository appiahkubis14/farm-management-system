{% extends 'web_base.html' %}
{% load static %}

{% block content %}
<br>
<!-- Page Header -->
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <h4 class="mb-0">Irrigation Overview</h4>
            <div class="page-title-right">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" id="addIrrigationBtn">
                        <i class="fas fa-plus me-1"></i> Add Irrigation Record
                    </button>
                    <button class="btn btn-outline-secondary" id="refreshDataBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<br>

<!-- Stats Cards -->
<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Irrigations</span>
                        <h4 class="mb-3" id="totalRecords">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-tint text-primary h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Total Volume (L)</span>
                        <h4 class="mb-3" id="totalVolume">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-water text-info h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">This Month</span>
                        <h4 class="mb-3" id="monthCount">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-calendar-alt text-success h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card card-h-30">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <span class="text-muted mb-3 lh-1 d-block text-truncate">Unique Farms</span>
                        <h4 class="mb-3" id="uniqueFarms">0</h4>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-map-marked-alt text-warning h2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-3">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Daily Irrigation Volume (Last 30 Days)</h6>
            </div>
            <div class="card-body">
                <canvas id="volumeChart" style="height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>By Irrigation Type</h6>
            </div>
            <div class="card-body">
                <canvas id="typeChart" style="height: 300px; width: 100%;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2">
                        <select class="form-select" id="districtFilter">
                            <option value="">All Districts</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="projectFilter">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="typeFilter">
                            <option value="">All Types</option>
                            {% for type in irrigation_types %}
                            <option value="{{ type }}">{{ type|title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="startDateFilter" placeholder="Start Date">
                    </div>
                    <div class="col-md-2">
                        <input type="date" class="form-control" id="endDateFilter" placeholder="End Date">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" id="applyFilters">
                            <i class="fas fa-filter me-1"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="irrigationTable" class="table table-striped datatable" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>UID</th>
                                <th>Farm Reference</th>
                                <th>Farmer Name</th>
                                <th>Irrigation Type</th>
                                <th>Water Volume (L)</th>
                                <th>Date</th>
                                <th>Agent</th>
                                <th>District</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Irrigation Modal -->
<div class="modal fade" id="irrigationModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Add Irrigation Record</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="irrigationForm" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="irrigationId" name="irrigation_id">
                    <input type="hidden" id="uid" name="uid">
                    
                    <!-- Farm Selection -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-farm me-2"></i>Farm Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="farm_id" class="form-label">Select Farm *</label>
                                    <select class="form-select" id="farm_id" name="farm_id" required>
                                        <option value="">Search and select farm...</option>
                                    </select>
                                    <div class="invalid-feedback">Please select a farm</div>
                                    <small class="text-muted">Type to search by farm reference or farmer name</small>
                                </div>
                            </div>
                            
                            <div class="row" id="farmDetails" style="display: none;">
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <strong>Farmer:</strong> <span id="displayFarmerName"></span><br>
                                        <strong>Location:</strong> <span id="displayLocation"></span><br>
                                        <strong>District:</strong> <span id="displayDistrict"></span><br>
                                        <strong>Farm Size:</strong> <span id="displayFarmSize"></span> ha
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Irrigation Details -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-tint me-2"></i>Irrigation Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="irrigation_type" class="form-label">Irrigation Type *</label>
                                    <select class="form-select" id="irrigation_type" name="irrigation_type" required>
                                        <option value="">Select Type</option>
                                        <option value="drip">Drip Irrigation</option>
                                        <option value="sprinkler">Sprinkler Irrigation</option>
                                        <option value="furrow">Furrow Irrigation</option>
                                        <option value="basin">Basin Irrigation</option>
                                        <option value="center pivot">Center Pivot</option>
                                    </select>
                                    <div class="invalid-feedback">Please select irrigation type</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="water_volume" class="form-label">Water Volume (Liters) *</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="water_volume" name="water_volume" required>
                                    <div class="invalid-feedback">Please enter water volume</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">Irrigation Date *</label>
                                    <input type="date" class="form-control" id="date" name="date" required>
                                    <div class="invalid-feedback">Please select date</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="agent_id" class="form-label">Agent (Staff)</label>
                                    <select class="form-select" id="agent_id" name="agent_id">
                                        <option value="">Select Agent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location/Project Info -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Location & Project</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="district_id" class="form-label">District</label>
                                    <select class="form-select" id="district_id" name="district_id">
                                        <option value="">Select District</option>
                                    </select>
                                    <small class="text-muted">Will auto-fill from farm if selected</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="project_id" class="form-label">Project</label>
                                    <select class="form-select" id="project_id" name="project_id">
                                        <option value="">Select Project</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="fas fa-save me-1"></i> Save Record
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Irrigation Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Irrigation Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="irrigationDetails">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="editFromViewBtn">
                    <i class="fas fa-edit me-1"></i> Edit
                </button>
                <button type="button" class="btn btn-info" id="printIrrigationBtn">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this irrigation record? This action cannot be undone.</p>
                <div class="form-group">
                    <label for="deleteReason" class="form-label">Reason for deletion:</label>
                    <textarea class="form-control" id="deleteReason" rows="3" placeholder="Enter reason for deletion..." required></textarea>
                </div>
                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Required CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" />

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    let volumeChart = null;
    let typeChart = null;
    let currentDeleteId = null;
    
    // ============== INITIALIZE TABLES ==============
    
    // Initialize DataTable
    var irrigationTable = $('#irrigationTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "{% url 'irrigation_list_api' %}",
            type: "GET",
            data: function(d) {
                // Add filter parameters
                d.district_id = $('#districtFilter').val();
                d.project_id = $('#projectFilter').val();
                d.irrigation_type = $('#typeFilter').val();
                d.start_date = $('#startDateFilter').val();
                d.end_date = $('#endDateFilter').val();
            }
        },
        columns: [
            { data: 'id', visible: false },
            { 
                data: 'uid',
                render: function(data, type, row) {
                    return `<a href="#" class="view-irrigation-link" data-id="${row.id}">${data}</a>`;
                }
            },
            { data: 'farm_reference' },
            { data: 'farmer_name' },
            { 
                data: 'irrigation_type_display',
                render: function(data, type, row) {
                    var badgeClass = row.irrigation_type_badge || 'bg-secondary';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'water_volume',
                render: function(data) {
                    return data ? data.toLocaleString() + ' L' : '0 L';
                }
            },
            { 
                data: 'date',
                render: function(data) {
                    return data || '<span class="text-muted">N/A</span>';
                }
            },
            { data: 'agent_name' },
            { data: 'district_name' },
            {
                data: 'id',
                render: function(data, type, row) {
                    return `
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info view-irrigation" data-id="${data}" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary edit-irrigation" data-id="${data}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger delete-irrigation" data-id="${data}" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                },
                orderable: false,
                searchable: false
            }
        ],
        responsive: true,
        order: [[6, 'desc']], // Sort by date descending
        dom: 'Bfrtip',
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            },
            {
                extend: "print",
                text: '<i class="fas fa-print"></i> Print',
                className: "btn btn-sm btn-outline-info",
            }
        ],
        language: {
            emptyTable: "No irrigation records found",
            zeroRecords: "No matching records found"
        }
    });
    
    // ============== LOAD DROPDOWN DATA ==============
    
    // Load Districts
    function loadDistricts(selectId, selectedId = null) {
        $.ajax({
            url: "{% url 'get_districts' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $select = $(selectId);
                    $select.empty().append('<option value="">All Districts</option>');
                    
                    response.data.forEach(function(district) {
                        var selected = (selectedId && district.id == selectedId) ? 'selected' : '';
                        $select.append(`<option value="${district.id}" ${selected}>${district.name}</option>`);
                    });
                }
            }
        });
    }
    
    // Load Projects
    function loadProjects(selectId, selectedId = null) {
        $.ajax({
            url: "{% url 'get_projects' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $select = $(selectId);
                    $select.empty().append('<option value="">All Projects</option>');
                    
                    response.data.forEach(function(project) {
                        var selected = (selectedId && project.id == selectedId) ? 'selected' : '';
                        $select.append(`<option value="${project.id}" ${selected}>${project.name}</option>`);
                    });
                }
            }
        });
    }
    
    // Load Staff
    function loadStaff(selectId, selectedId = null) {
        $.ajax({
            url: "{% url 'staff_list_dropdown_api' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    var $select = $(selectId);
                    $select.empty().append('<option value="">Select Agent</option>');
                    
                    response.data.forEach(function(staff) {
                        var selected = (selectedId && staff.id == selectedId) ? 'selected' : '';
                        $select.append(`<option value="${staff.id}" ${selected}>${staff.display}</option>`);
                    });
                }
            }
        });
    }
    
    // Initialize Select2 for farm dropdown
    function initFarmSelect(selectedId = null) {
        $('#farm_id').select2({
            dropdownParent: $('#irrigationModal'),
            placeholder: 'Search for a farm...',
            allowClear: true,
            width: '100%',
            ajax: {
                url: "{% url 'farm_list_api' %}",
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        search: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function(data, params) {
                    if (data.success) {
                        return {
                            results: data.data.map(function(farm) {
                                return {
                                    id: farm.id,
                                    text: farm.display
                                };
                            })
                        };
                    }
                    return { results: [] };
                },
                cache: true
            },
            minimumInputLength: 2
        });
        
        if (selectedId) {
            // If we have a selected ID, we need to load it
            $.ajax({
                url: "{% url 'farm_list_api' %}",
                data: { ids: selectedId },
                success: function(response) {
                    if (response.success && response.data.length > 0) {
                        var farm = response.data[0];
                        var option = new Option(farm.display, farm.id, true, true);
                        $('#farm_id').append(option).trigger('change');
                        
                        // Display farm details
                        $('#displayFarmerName').text(farm.farmername);
                        $('#displayLocation').text(farm.location || 'N/A');
                        $('#displayDistrict').text(farm.district || 'N/A');
                        $('#farmDetails').show();
                    }
                }
            });
        }
    }
    
    // Farm selection change handler
    $('#farm_id').on('change', function() {
        var farmId = $(this).val();
        if (farmId) {
            // Get farm details
            $.ajax({
                url: "{% url 'farm_list_api' %}",
                data: { ids: farmId },
                success: function(response) {
                    if (response.success && response.data.length > 0) {
                        var farm = response.data[0];
                        $('#displayFarmerName').text(farm.farmername);
                        $('#displayLocation').text(farm.location || 'N/A');
                        $('#displayDistrict').text(farm.district || 'N/A');
                        $('#displayFarmSize').text(farm.farm_size || 'N/A');
                        $('#farmDetails').show();
                        
                        // Auto-fill district if not already set
                        if (!$('#district_id').val() && farm.district_id) {
                            $('#district_id').val(farm.district_id);
                        }
                    }
                }
            });
        } else {
            $('#farmDetails').hide();
        }
    });
    
    // ============== LOAD STATS AND CHARTS ==============
    
    function loadStats() {
        $.ajax({
            url: "{% url 'irrigation_stats_api' %}",
            type: "GET",
            data: {
                district_id: $('#districtFilter').val(),
                project_id: $('#projectFilter').val(),
                start_date: $('#startDateFilter').val(),
                end_date: $('#endDateFilter').val()
            },
            success: function(response) {
                if (response.success) {
                    var stats = response.data;
                    $('#totalRecords').text(stats.total_records || 0);
                    $('#totalVolume').text(stats.total_volume ? stats.total_volume.toLocaleString() : '0');
                    $('#monthCount').text(stats.month_count || 0);
                    $('#uniqueFarms').text(stats.unique_farms || 0);
                }
            }
        });
    }
    
    function loadCharts() {
        $.ajax({
            url: "{% url 'irrigation_chart_api' %}",
            type: "GET",
            data: {
                district_id: $('#districtFilter').val(),
                project_id: $('#projectFilter').val()
            },
            success: function(response) {
                if (response.success) {
                    updateCharts(response.data);
                }
            }
        });
    }
    
    function updateCharts(data) {
        // Volume Chart
        if (volumeChart) {
            volumeChart.destroy();
        }
        
        var ctx = document.getElementById('volumeChart').getContext('2d');
        volumeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.daily.map(d => d.date),
                datasets: [{
                    label: 'Water Volume (Liters)',
                    data: data.daily.map(d => d.volume),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Volume (Liters)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        
        // Type Chart
        if (typeChart) {
            typeChart.destroy();
        }
        
        var typeCtx = document.getElementById('typeChart').getContext('2d');
        
        var typeLabels = data.by_type.map(t => t.irrigation_type ? t.irrigation_type.toUpperCase() : 'Unknown');
        var typeData = data.by_type.map(t => t.count);
        var backgroundColors = [
            'rgba(40, 167, 69, 0.8)',   // success - drip
            'rgba(23, 162, 184, 0.8)',  // info - sprinkler
            'rgba(255, 193, 7, 0.8)',   // warning - furrow
            'rgba(0, 123, 255, 0.8)',   // primary - basin
            'rgba(220, 53, 69, 0.8)'    // danger - center pivot
        ];
        
        typeChart = new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeData,
                    backgroundColor: backgroundColors.slice(0, typeLabels.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // ============== EVENT HANDLERS ==============
    
    // Apply filters
    $('#applyFilters').click(function() {
        irrigationTable.ajax.reload();
        loadStats();
        loadCharts();
    });
    
    // Refresh data
    $('#refreshDataBtn').click(function() {
        irrigationTable.ajax.reload();
        loadStats();
        loadCharts();
        Swal.fire('Refreshed', 'Data has been refreshed', 'success');
    });
    
    // Add Irrigation Button
    $('#addIrrigationBtn').click(function() {
        $('#irrigationForm')[0].reset();
        $('#irrigationForm').removeClass('was-validated');
        $('#modalTitle').text('Add Irrigation Record');
        $('#irrigationId').val('');
        $('#uid').val('');
        $('#farm_id').val(null).trigger('change');
        $('#farmDetails').hide();
        
        var today = new Date().toISOString().split('T')[0];
        $('#date').val(today);
        
        loadDistricts('#district_id');
        loadProjects('#project_id');
        loadStaff('#agent_id');
        initFarmSelect();
        
        $('#irrigationModal').modal('show');
    });
    
    // Edit Irrigation
    $(document).on('click', '.edit-irrigation', function() {
        var irrigationId = $(this).data('id');
        
        $.ajax({
            url: "{% url 'irrigation_detail_api' 0 %}".replace('0', irrigationId),
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    var irr = response.data;
                    
                    // Load dependent data
                    loadDistricts('#district_id', irr.district_id);
                    loadProjects('#project_id', irr.project_id);
                    loadStaff('#agent_id', irr.agent_id);
                    
                    // Initialize farm select with selected value
                    initFarmSelect(irr.farm_id);
                    
                    // Populate form
                    $('#irrigationId').val(irr.id);
                    $('#uid').val(irr.uid);
                    $('#irrigation_type').val(irr.irrigation_type);
                    $('#water_volume').val(irr.water_volume);
                    $('#date').val(irr.date);
                    
                    $('#modalTitle').text('Edit Irrigation Record');
                    $('#irrigationModal').modal('show');
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Failed to load irrigation details', 'error');
            }
        });
    });
    
    // View Irrigation
    $(document).on('click', '.view-irrigation, .view-irrigation-link', function(e) {
        if (e) e.preventDefault();
        var irrigationId = $(this).data('id');
        
        $.ajax({
            url: "{% url 'irrigation_detail_api' 0 %}".replace('0', irrigationId),
            type: 'GET',
            beforeSend: function() {
                $('#irrigationDetails').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading irrigation details...</p>
                    </div>
                `);
            },
            success: function(response) {
                if (response.success) {
                    var i = response.data;
                    
                    var typeBadge = 'bg-success';
                    if (i.irrigation_type === 'sprinkler') typeBadge = 'bg-info';
                    else if (i.irrigation_type === 'furrow') typeBadge = 'bg-warning';
                    else if (i.irrigation_type === 'basin') typeBadge = 'bg-primary';
                    else if (i.irrigation_type === 'center pivot') typeBadge = 'bg-danger';
                    
                    var html = `
                        <div class="irrigation-details">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2 text-primary">Irrigation Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">UID:</th>
                                            <td><strong>${i.uid || 'N/A'}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Irrigation Type:</th>
                                            <td><span class="badge ${typeBadge}">${i.irrigation_type ? i.irrigation_type.toUpperCase() : 'N/A'}</span></td>
                                        </tr>
                                        <tr>
                                            <th>Water Volume:</th>
                                            <td><strong>${i.water_volume ? i.water_volume.toLocaleString() : '0'}</strong> Liters</td>
                                        </tr>
                                        <tr>
                                            <th>Irrigation Date:</th>
                                            <td>${i.date || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2 text-primary">Farm Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">Farm Reference:</th>
                                            <td><strong>${i.farm_reference || 'N/A'}</strong></td>
                                        </tr>
                                        <tr>
                                            <th>Farmer Name:</th>
                                            <td>${i.farmer_name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Location:</th>
                                            <td>${i.farm_location || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Farm Size:</th>
                                            <td>${i.farm_size || 'N/A'} ha</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2">Agent Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">Agent Name:</th>
                                            <td>${i.agent_name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Contact:</th>
                                            <td>${i.agent_contact || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h5 class="border-bottom pb-2">Location & Project</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="40%">District:</th>
                                            <td>${i.district_name || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Project:</th>
                                            <td>${i.project_name || 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2">System Information</h5>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="20%">Created Date:</th>
                                            <td><small>${i.created_date || 'N/A'}</small></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    $('#irrigationDetails').html(html);
                    
                    $('#editFromViewBtn').data('id', i.id);
                    $('#viewModal').modal('show');
                } else {
                    $('#irrigationDetails').html(`
                        <div class="alert alert-danger">
                            Failed to load details: ${response.message}
                        </div>
                    `);
                }
            },
            error: function() {
                $('#irrigationDetails').html(`
                    <div class="alert alert-danger">
                        Failed to load irrigation details
                    </div>
                `);
            }
        });
    });
    
    // Edit from view modal
    $('#editFromViewBtn').click(function() {
        var irrigationId = $(this).data('id');
        $('#viewModal').modal('hide');
        $(`.edit-irrigation[data-id="${irrigationId}"]`).click();
    });
    
    // Form Submission
    $('#irrigationForm').submit(function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
            e.stopPropagation();
            $(this).addClass('was-validated');
            return;
        }
        
        var formData = {
            farm_id: $('#farm_id').val(),
            irrigation_type: $('#irrigation_type').val(),
            water_volume: $('#water_volume').val(),
            date: $('#date').val(),
            agent_id: $('#agent_id').val() || null,
            district_id: $('#district_id').val() || null,
            project_id: $('#project_id').val() || null,
            uid: $('#uid').val() || null
        };
        
        var irrigationId = $('#irrigationId').val();
        var url = irrigationId ? 
            "{% url 'irrigation_update' 0 %}".replace('0', irrigationId) : 
            "{% url 'irrigation_create' %}";
        
        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#saveBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#irrigationModal').modal('hide');
                    irrigationTable.ajax.reload();
                    loadStats();
                    loadCharts();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#saveBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i> Save Record');
            }
        });
    });
    
    // Delete Irrigation
    $(document).on('click', '.delete-irrigation', function() {
        currentDeleteId = $(this).data('id');
        $('#deleteReason').val('');
        $('#deleteModal').modal('show');
    });
    
    $('#confirmDeleteBtn').click(function() {
        var reason = $('#deleteReason').val();
        if (!reason.trim()) {
            Swal.fire('Error', 'Please provide a reason for deletion', 'error');
            return;
        }
        
        $.ajax({
            url: "{% url 'irrigation_delete' 0 %}".replace('0', currentDeleteId),
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ reason: reason }),
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            beforeSend: function() {
                $('#confirmDeleteBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');
            },
            success: function(response) {
                if (response.success) {
                    Swal.fire('Success', response.message, 'success');
                    $('#deleteModal').modal('hide');
                    irrigationTable.ajax.reload();
                    loadStats();
                    loadCharts();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                var errorMsg = 'An error occurred';
                try {
                    var response = JSON.parse(xhr.responseText);
                    errorMsg = response.message || errorMsg;
                } catch(e) {
                    errorMsg = xhr.statusText || errorMsg;
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#confirmDeleteBtn').prop('disabled', false).html('Delete');
            }
        });
    });
    
    // Print Irrigation Details
    $('#printIrrigationBtn').click(function() {
        var printContent = $('#irrigationDetails').html();
        var originalContent = $('body').html();
        
        $('body').html(`
            <div class="container mt-5">
                <h2 class="text-center mb-4 text-primary">Irrigation Record</h2>
                <div class="text-center mb-4">
                    <h5>Irrigation Details</h5>
                </div>
                ${printContent}
                <div class="mt-5 text-center">
                    <small>Printed on: ${new Date().toLocaleString()}</small>
                </div>
            </div>
        `);
        
        window.print();
        $('body').html(originalContent);
        location.reload();
    });
    
    // CSRF Token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Set default date to today
    $('#date').val(new Date().toISOString().split('T')[0]);
    
    // Initial loads
    loadDistricts('#districtFilter');
    loadDistricts('#district_id');
    loadProjects('#projectFilter');
    loadProjects('#project_id');
    loadStaff('#agent_id');
    initFarmSelect();
    loadStats();
    loadCharts();
});
</script>

<style>
.card-h-30 {
    min-height: 120px;
}

.irrigation-details h5 {
    color: #495057;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.irrigation-details table {
    margin-bottom: 0;
}

.irrigation-details th {
    font-weight: 500;
    color: #6c757d;
    font-size: 0.9rem;
}

.irrigation-details td {
    font-size: 0.95rem;
}

.badge {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.view-irrigation-link {
    color: #0d6efd;
    text-decoration: none;
    cursor: pointer;
    font-weight: 500;
}

.view-irrigation-link:hover {
    text-decoration: underline;
}

.select2-container--default .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
}

.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
}

.select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 36px;
}

@media print {
    .modal-header, .modal-footer, .btn, .btn-group {
        display: none !important;
    }
    
    .modal-dialog {
        max-width: 100% !important;
        margin: 0 !important;
    }
    
    .modal-content {
        border: none !important;
        box-shadow: none !important;
    }
    
    .modal-body {
        padding: 0 !important;
    }
    
    .irrigation-details {
        font-size: 12pt;
    }
}
</style>
{% endblock %}